# Deploy Pipeline - Railway Deployment
# Triggered on push to main (production) or development (staging)
# Railway auto-deploys via GitHub integration when connected
# This workflow provides deployment verification and optional manual triggers

name: Deploy

on:
  push:
    branches: [main, development]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - production
          - staging
      skip_health_check:
        description: 'Skip post-deployment health check'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: "20"

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false  # Never cancel in-progress deployments

jobs:
  # =============================================================================
  # Determine deployment environment based on branch or manual input
  # =============================================================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      backend_url: ${{ steps.env.outputs.backend_url }}
      frontend_url: ${{ steps.env.outputs.frontend_url }}
      cors_origins: ${{ steps.env.outputs.cors_origins }}
    steps:
      - name: Determine environment
        id: env
        run: |
          # Determine environment from branch or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set URLs based on environment
          if [ "$ENV" = "production" ]; then
            echo "backend_url=https://backend-production-5c11.up.railway.app" >> $GITHUB_OUTPUT
            echo "frontend_url=https://nuvanaapp.com" >> $GITHUB_OUTPUT
            echo "cors_origins=https://nuvanaapp.com,https://www.nuvanaapp.com" >> $GITHUB_OUTPUT
          else
            echo "backend_url=https://backend-production-5c11.up.railway.app" >> $GITHUB_OUTPUT
            echo "frontend_url=https://staging.nuvanaapp.com" >> $GITHUB_OUTPUT
            echo "cors_origins=https://staging.nuvanaapp.com" >> $GITHUB_OUTPUT
          fi

          echo "## Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Pre-deployment validation (fast sanity check)
  # =============================================================================
  pre-deploy:
    name: Pre-deployment Validation
    needs: setup
    runs-on: ubuntu-latest
    outputs:
      deploy_sha: ${{ steps.info.outputs.sha }}
      deploy_time: ${{ steps.info.outputs.time }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Capture deployment info
        id: info
        run: |
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install backend dependencies
        run: cd backend && npm ci

      - name: Validate builds
        run: |
          echo "Building frontend..."
          npm run build
          echo "Building backend..."
          cd backend && npm run build
        env:
          DATABASE_URL: "postgresql://dummy:dummy@dummy:5432/dummy"
          NODE_ENV: "production"
          NEXT_PUBLIC_BACKEND_URL: "${{ needs.setup.outputs.backend_url }}"

  # =============================================================================
  # Railway Deployment (triggered by GitHub integration OR manual)
  # =============================================================================
  deploy:
    name: Deploy to Railway (${{ needs.setup.outputs.environment }})
    needs: [setup, pre-deploy]
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ needs.setup.outputs.frontend_url }}
    steps:
      - name: Deployment started
        run: |
          echo "## Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.pre-deploy.outputs.deploy_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** ${{ needs.pre-deploy.outputs.deploy_time }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Railway will auto-deploy via GitHub integration." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** ${{ needs.setup.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend:** ${{ needs.setup.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CORS Configuration" >> $GITHUB_STEP_SUMMARY
          echo "Allowed Origins: \`${{ needs.setup.outputs.cors_origins }}\`" >> $GITHUB_STEP_SUMMARY

      # Optional: Use Railway CLI for explicit deployment control
      # Uncomment and add RAILWAY_TOKEN secret if you want CLI-based deployments
      # - name: Install Railway CLI
      #   run: npm install -g @railway/cli
      #
      # - name: Deploy Backend
      #   run: railway up --service backend
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      #
      # - name: Deploy Frontend
      #   run: railway up --service frontend
      #   env:
      #     RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # =============================================================================
  # Post-deployment health verification
  # =============================================================================
  health-check:
    name: Verify Deployment Health (${{ needs.setup.outputs.environment }})
    needs: [setup, pre-deploy, deploy]
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_health_check }}
    steps:
      - name: Wait for Railway deployment propagation
        run: sleep 60  # Give Railway time to complete deployment

      - name: Check Backend Health
        id: backend_health
        run: |
          BACKEND_URL="${{ needs.setup.outputs.backend_url }}"
          echo "Checking backend health at $BACKEND_URL..."
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/api/health" || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Backend is healthy!"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i: Backend returned $HTTP_STATUS, retrying in 30s..."
            sleep 30
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "::warning::Backend health check failed after 10 attempts"

      - name: Check Frontend Health
        id: frontend_health
        run: |
          FRONTEND_URL="${{ needs.setup.outputs.frontend_url }}"
          echo "Checking frontend health at $FRONTEND_URL..."
          for i in {1..10}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "Frontend is healthy!"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Attempt $i: Frontend returned $HTTP_STATUS, retrying in 30s..."
            sleep 30
          done
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "::warning::Frontend health check failed after 10 attempts"

      - name: Verify CORS Configuration
        id: cors_check
        run: |
          BACKEND_URL="${{ needs.setup.outputs.backend_url }}"
          FRONTEND_URL="${{ needs.setup.outputs.frontend_url }}"
          echo "Verifying CORS configuration..."

          # Send preflight request
          CORS_HEADERS=$(curl -s -I -X OPTIONS \
            -H "Origin: $FRONTEND_URL" \
            -H "Access-Control-Request-Method: GET" \
            -H "Access-Control-Request-Headers: Content-Type,Authorization" \
            "$BACKEND_URL/api/health" 2>&1)

          # Check for Access-Control-Allow-Origin header
          if echo "$CORS_HEADERS" | grep -qi "access-control-allow-origin"; then
            ALLOWED_ORIGIN=$(echo "$CORS_HEADERS" | grep -i "access-control-allow-origin" | cut -d: -f2- | tr -d ' \r')
            echo "CORS configured: Access-Control-Allow-Origin: $ALLOWED_ORIGIN"

            # Verify the frontend URL is in the allowed origin
            if echo "$ALLOWED_ORIGIN" | grep -q "$FRONTEND_URL"; then
              echo "✅ CORS correctly configured for $FRONTEND_URL"
              echo "status=valid" >> $GITHUB_OUTPUT
            else
              echo "⚠️ CORS header present but may not include $FRONTEND_URL"
              echo "status=warning" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ No Access-Control-Allow-Origin header found"
            echo "status=missing" >> $GITHUB_OUTPUT
          fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.backend_health.outputs.status == 'healthy' && '✅ Healthy' || '⚠️ Check Required' }} | ${{ needs.setup.outputs.backend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.frontend_health.outputs.status == 'healthy' && '✅ Healthy' || '⚠️ Check Required' }} | ${{ needs.setup.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CORS | ${{ steps.cors_check.outputs.status == 'valid' && '✅ Valid' || (steps.cors_check.outputs.status == 'warning' && '⚠️ Warning' || '❌ Missing') }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Commit:** \`${{ needs.pre-deploy.outputs.deploy_sha }}\`" >> $GITHUB_STEP_SUMMARY
