# Stage 0 + Stage 1 + Stage 2 + Stage 3 + Stage 4 + Stage 5 + Stage 6 (Foundation + Component + API + E2E + Stability + Security + Artifacts)
# Progressive CI pipeline following progression plan
# SECURITY HARDENED: All secrets in GitHub Secrets, actions pinned to SHAs, artifact signing, log scrubbing

name: Lean CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Default permissions (least privilege)
permissions:
  contents: read

env:
  NODE_VERSION: "20"
  BACKEND_URL: "http://localhost:3001"
  FRONTEND_URL: "http://localhost:3000"
  NEXT_TELEMETRY_DISABLED: "1"
  BURN_IN_ITERATIONS: "5"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client for type checking
        run: npm run prisma:generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
      - run: npm run lint
      - run: npx tsc --noEmit
      - name: Type-check backend
        run: cd backend && npx tsc --noEmit

  test_selector:
    name: Select Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      component: ${{ steps.select_tests.outputs.component }}
      api: ${{ steps.select_tests.outputs.api }}
      e2e: ${{ steps.select_tests.outputs.e2e }}
      any: ${{ steps.calculate_any.outputs.any }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Select tests to run
        id: select_tests
        run: |
          # Determine which tests to run based on changed files
          bash nuvana_control/workflows/11-ci_pipeline/scripts/test-changed.sh --select-only
      - name: Calculate if any tests should run
        id: calculate_any
        run: |
          if [[ "${{ steps.select_tests.outputs.component }}" == "true" ]] || [[ "${{ steps.select_tests.outputs.api }}" == "true" ]] || [[ "${{ steps.select_tests.outputs.e2e }}" == "true" ]]; then
            echo "any=true" >> $GITHUB_OUTPUT
          else
            echo "any=false" >> $GITHUB_OUTPUT
          fi

  selective_tests:
    name: Selective Tests
    needs: [lint_typecheck, test_selector]
    runs-on: ubuntu-latest
    if: ${{ needs.test_selector.outputs.any == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: cd backend && npm ci
      - name: Generate Prisma Client (root)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: npm run prisma:generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Generate Prisma Client (backend)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed test database
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Cache Playwright browsers
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Install Playwright browsers
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: npx playwright install --with-deps chromium
      - name: Build backend
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: cd backend && npm run build
      - name: Clean up port 3001 (if occupied)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend (if API tests needed)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000  # Increased limit for bulk import tests
          UPLOAD_RATE_LIMIT_MAX: 1000  # Increased rate limit for bulk import tests
      - name: Start transaction worker (if API tests needed)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: |
          cd backend && npm run worker:transaction > ../worker.log 2>&1 &
          echo $! > ../worker.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend health (if started)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: |
          echo "Waiting for backend to be healthy..."
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done
          echo "Backend health check timeout - may not be needed for this test run"
        continue-on-error: false
      - name: Wait for transaction worker readiness (if started)
        if: (needs.test_selector.outputs.api == 'true' || needs.test_selector.outputs.e2e == 'true')
        run: |
          echo "Waiting for transaction worker to be ready..."
          for i in {1..30}; do
            if grep -q "Transaction worker started successfully" worker.log 2>/dev/null; then
              echo "✅ Transaction worker is ready"
              exit 0
            fi
            # Also check if worker process crashed
            if [ -f worker.pid ]; then
              if ! kill -0 $(cat worker.pid) 2>/dev/null; then
                echo "❌ Transaction worker process died"
                echo "Worker logs:"
                cat worker.log || echo "No worker.log found"
                exit 1
              fi
            fi
            echo "Waiting for worker... ($i/30)"
            sleep $((i > 10 ? 3 : 1))
          done
          echo "❌ Transaction worker readiness timeout"
          echo "Worker logs:"
          cat worker.log || echo "No worker.log found"
          exit 1
      - name: Run selective tests
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/test-changed.sh
      - name: Scrub secrets from logs
        if: failure()
        run: |
          for log_file in backend.log worker.log; do
            if [ -f "$log_file" ]; then
              sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' "$log_file"
              sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' "$log_file"
              sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' "$log_file"
              sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' "$log_file"
              sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' "$log_file"
            fi
          done
      - name: Upload backend and worker logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-selective-tests
          path: |
            backend.log
            worker.log
          retention-days: 7
      - name: Stop backend and worker
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) 2>/dev/null || true
            rm -f worker.pid
          fi
          # Extra cleanup: kill any remaining process on port 3001
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  changed_tests_burn_in:
    name: Burn-In Changed Tests
    needs: [selective_tests, test_selector, e2e_smoke]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ needs.test_selector.outputs.any == 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up ports (if occupied)
        run: |
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start full stack (frontend, backend, and worker)
        run: |
          npm run dev:frontend > frontend.log 2>&1 &
          echo $! > frontend.pid
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
          cd backend && npm run worker:transaction > ../worker.log 2>&1 &
          echo $! > ../worker.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          BACKEND_URL: ${{ env.BACKEND_URL }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000  # Increased limit for bulk import tests
          UPLOAD_RATE_LIMIT_MAX: 1000  # Increased rate limit for bulk import tests
      - name: Wait for frontend and backend
        run: |
          echo "Waiting for frontend..."
          FRONTEND_READY=false
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.FRONTEND_URL }} > /dev/null 2>&1; then
              echo "Frontend is ready"
              FRONTEND_READY=true
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done

          if [ "$FRONTEND_READY" = false ]; then
            echo "❌ Frontend failed to start"
            echo "Frontend logs:"
            cat frontend.log || echo "No frontend.log found"
            exit 1
          fi

          echo "Waiting for backend..."
          BACKEND_READY=false
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              BACKEND_READY=true
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done

          if [ "$BACKEND_READY" = false ]; then
            echo "❌ Backend failed to start"
            echo "Backend logs:"
            cat backend.log || echo "No backend.log found"
            exit 1
          fi

          echo "✅ Both services are ready"
      - name: Wait for transaction worker readiness
        run: |
          echo "Waiting for transaction worker to be ready..."
          for i in {1..30}; do
            if grep -q "Transaction worker started successfully" worker.log 2>/dev/null; then
              echo "✅ Transaction worker is ready"
              exit 0
            fi
            # Also check if worker process crashed
            if [ -f worker.pid ]; then
              if ! kill -0 $(cat worker.pid) 2>/dev/null; then
                echo "❌ Transaction worker process died"
                echo "Worker logs:"
                cat worker.log || echo "No worker.log found"
                exit 1
              fi
            fi
            echo "Waiting for worker... ($i/30)"
            sleep $((i > 10 ? 3 : 1))
          done
          echo "❌ Transaction worker readiness timeout"
          echo "Worker logs:"
          cat worker.log || echo "No worker.log found"
          exit 1
      - name: Run burn-in loop
        env:
          BURN_IN_ITERATIONS: ${{ env.BURN_IN_ITERATIONS }}
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/burn-in.sh
      - name: Scrub secrets from logs
        if: failure()
        run: |
          for log_file in frontend.log backend.log worker.log; do
            if [ -f "$log_file" ]; then
              sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' "$log_file"
              sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' "$log_file"
              sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' "$log_file"
              sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' "$log_file"
              sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' "$log_file"
            fi
          done
      - name: Upload full stack logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: full-stack-logs-burn-in
          path: |
            frontend.log
            backend.log
            worker.log
          retention-days: 7
      - name: Stop full stack
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) 2>/dev/null || true
            rm -f frontend.pid
          fi
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) 2>/dev/null || true
            rm -f worker.pid
          fi
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          # Extra cleanup: kill any remaining processes on ports
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000 || true
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  component_smoke:
    name: Component Smoke
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Run component tests
        run: npm run test:component -- --reporter=dot -- --coverage
      - name: Upload component coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: coverage-component
          path: coverage
          retention-days: 7

  unit_tests:
    name: Unit Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed RBAC roles
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run unit tests
        run: npm run test:unit -- --coverage
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: coverage-unit
          path: coverage
          retention-days: 7

  api_smoke:
    name: API Smoke
    needs: lint_typecheck
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed roles for auth
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up port 3001 (if occupied)
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000  # Increased limit for bulk import tests
          UPLOAD_RATE_LIMIT_MAX: 1000  # Increased rate limit for bulk import tests
      - name: Wait for backend health
        id: wait_backend_api_smoke
        run: |
          echo "Waiting for backend to be healthy (checking /api/health)..."
          for i in {1..60}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is healthy and ready"
              echo "health_check_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for backend health check... ($i/60)"
            sleep $((i > 20 ? 5 : 3))
          done
          echo "Backend health check failed after 3 minutes"
          echo "health_check_passed=false" >> $GITHUB_OUTPUT
          echo "Backend logs:"
          cat backend.log || true
          exit 1
      - name: Run health check test
        if: steps.wait_backend_api_smoke.outputs.health_check_passed == 'true'
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: npm run test:api:health
      - name: Scrub secrets from logs
        if: failure()
        run: |
          if [ -f backend.log ]; then
            sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' backend.log
            sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' backend.log
            sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' backend.log
            sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' backend.log
            sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' backend.log
          fi
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-api-smoke
          path: backend.log
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          # Extra cleanup: kill any remaining process on port 3001
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  build_app:
    name: Build Application
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - run: npm run build

  e2e_smoke:
    name: E2E Smoke
    needs: build_app
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up ports (if occupied)
        run: |
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start full stack
        run: |
          npm run dev:frontend > frontend.log 2>&1 &
          echo $! > frontend.pid
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          BACKEND_URL: ${{ env.BACKEND_URL }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000  # Increased limit for bulk import tests
          UPLOAD_RATE_LIMIT_MAX: 1000  # Increased rate limit for bulk import tests
      - name: Wait for frontend and backend
        run: |
          echo "Waiting for frontend..."
          FRONTEND_READY=false
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.FRONTEND_URL }} > /dev/null 2>&1; then
              echo "Frontend is ready"
              FRONTEND_READY=true
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done

          if [ "$FRONTEND_READY" = false ]; then
            echo "❌ Frontend failed to start"
            echo "Frontend logs:"
            cat frontend.log || echo "No frontend.log found"
            exit 1
          fi

          echo "Waiting for backend..."
          BACKEND_READY=false
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              BACKEND_READY=true
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done

          if [ "$BACKEND_READY" = false ]; then
            echo "❌ Backend failed to start"
            echo "Backend logs:"
            cat backend.log || echo "No backend.log found"
            exit 1
          fi

          echo "✅ Both services are ready"
      - name: Run E2E health check
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
        run: npm run test:e2e:health
      - name: Scrub secrets from logs
        if: failure()
        run: |
          for log_file in frontend.log backend.log; do
            if [ -f "$log_file" ]; then
              sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' "$log_file"
              sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' "$log_file"
              sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' "$log_file"
              sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' "$log_file"
              sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' "$log_file"
            fi
          done
      - name: Upload full stack logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: full-stack-logs-e2e-smoke
          path: |
            frontend.log
            backend.log
          retention-days: 7
      - name: Stop full stack
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) 2>/dev/null || true
            rm -f frontend.pid
          fi
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          if [ -f full.pid ]; then
            kill $(cat full.pid) 2>/dev/null || true
            rm -f full.pid
          fi
          # Extra cleanup: kill any remaining processes on ports
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000 || true
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  security_static:
    name: Static Security & Dependencies
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0  # Full history needed for gitleaks to compare commits
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Semgrep OWASP
        uses: returntocorp/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d  # v1
        with:
          config: p/owasp-top-ten
      - name: npm audit (high severity)
        run: npm audit --omit=dev --audit-level=high
      - name: npm audit (high severity - backend)
        run: cd backend && npm audit --omit=dev --audit-level=high
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate SBOM (CycloneDX)
        uses: CycloneDX/gh-node-module-generatebom@27e13c2bf0fae78d66387b35ca9749d8cc853060  # v1.0.3
        with:
          output: sbom.xml
      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: sbom-node
          path: sbom.xml
          retention-days: 30
      - name: License check
        run: node nuvana_control/workflows/11-ci_pipeline/scripts/license-check.js

  security_dynamic:
    name: Dynamic Security
    needs: security_static
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
      issues: write
      security-events: write
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed roles for auth
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up port 3001 (if occupied)
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000  # Increased limit for bulk import tests
          UPLOAD_RATE_LIMIT_MAX: 1000  # Increased rate limit for bulk import tests
      - name: Wait for backend
        id: wait_backend
        run: |
          echo "Waiting for backend to be healthy (checking /api/health)..."
          for i in {1..60}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is healthy and ready"
              echo "health_check_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for backend health check... ($i/60)"
            sleep $((i > 20 ? 5 : 3))
          done
          echo "Backend health check failed after 3 minutes"
          echo "health_check_passed=false" >> $GITHUB_OUTPUT
          echo "Backend logs:"
          cat backend.log || true
          exit 1
      - name: Obtain auth cookies
        if: steps.wait_backend.outputs.health_check_passed == 'true'
        id: zap_auth
        run: |
          RESPONSE_HEADERS=$(curl -i -s -X POST "${{ env.BACKEND_URL }}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@nuvana.com","password":"Admin123!"}')
          COOKIES=$(echo "$RESPONSE_HEADERS" | grep -i '^set-cookie:' | cut -d' ' -f2- | cut -d';' -f1 | tr '\n' '; ' | sed 's/; $//')
          if [ -z "$COOKIES" ]; then
            echo "Failed to retrieve auth cookies"
            exit 1
          fi
          echo "cookie_header=$COOKIES" >> $GITHUB_OUTPUT
      - name: OWASP ZAP baseline (authenticated)
        if: steps.wait_backend.outputs.health_check_passed == 'true' && steps.zap_auth.outputs.cookie_header
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25  # v0.15.0
        with:
          target: ${{ env.BACKEND_URL }}
          fail_action: true
          artifact_name: zap-scan-report
          # Allow informational alerts but fail on low/medium/high severity findings
          rules_file_name: '.zap/rules.tsv'
          cmd_options: "-I -z \"-config replacer.full_list(0).description=auth-cookies -config replacer.full_list(0).enabled=true -config replacer.full_list(0).matchtype=REQ_HEADER -config replacer.full_list(0).matchstr=Cookie -config replacer.full_list(0).replacement=${{ steps.zap_auth.outputs.cookie_header }}\""
      - name: Scrub secrets from logs
        if: failure()
        run: |
          if [ -f backend.log ]; then
            sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' backend.log
            sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' backend.log
            sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' backend.log
            sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' backend.log
            sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' backend.log
          fi
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-security-dynamic
          path: backend.log
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          # Extra cleanup: kill any remaining process on port 3001
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  artifact_build:
    name: Build & Upload Artifacts
    needs: build_app
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for artifact attestation
      attestations: write  # Required for artifact attestation
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - run: npm run build
      - name: Generate build provenance attestation
        uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c  # v1.4.3
        with:
          subject-path: |
            .next/**
            backend/dist/**
      - name: Upload bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: build-output
          path: |
            .next
            backend/dist
            package-lock.json
          retention-days: 30

  deployment_gate:
    name: Deploy to Production
    needs: [security_static, security_dynamic, e2e_smoke, artifact_build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: build-output
          path: ./build-output
      - name: Display artifact contents
        run: ls -R ./build-output
      - name: Deploy (placeholder)
        run: |
          echo "Artifacts ready at ./build-output (.next, backend/dist)."
          echo "Insert your deployment command here (e.g., push image or upload bundle)."
          echo "Deployment is gated by the production environment approval settings."



