# Stage 0 + Stage 1 + Stage 2 + Stage 3 + Stage 4 + Stage 5 (Foundation + Component + API + E2E + Stability + Security)
# Progressive CI pipeline following progression plan

name: Lean CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

env:
  NODE_VERSION: "20"
  BACKEND_URL: "http://localhost:3001"
  FRONTEND_URL: "http://localhost:3000"
  NEXT_TELEMETRY_DISABLED: "1"
  BURN_IN_ITERATIONS: "5"

jobs:
  lint_typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - run: npm run lint
      - run: npx tsc --noEmit
      - name: Type-check backend
        run: cd backend && npx tsc --noEmit

  selective_tests:
    name: Selective Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Start backend (if API tests needed)
        run: |
          cd backend && node dist/app.js > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend health (if started)
        run: |
          for i in {1..30}; do
            if curl -sf ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend health check timeout - may not be needed for this test run"
        continue-on-error: true
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Run selective tests
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/test-changed.sh
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi

  changed_tests_burn_in:
    name: Burn-In Changed Tests
    needs: selective_tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Start backend (if API/E2E tests needed)
        run: |
          cd backend && node dist/app.js > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend health (if started)
        run: |
          for i in {1..30}; do
            if curl -sf ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend health check timeout - may not be needed for this test run"
        continue-on-error: true
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Run burn-in loop
        env:
          BURN_IN_ITERATIONS: ${{ env.BURN_IN_ITERATIONS }}
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/burn-in.sh
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi

  component_smoke:
    name: Component Smoke
    needs: lint_typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Run component tests
        run: npm run test:component -- --reporter=dot

  api_smoke:
    name: API Smoke
    needs: lint_typecheck
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Start backend
        run: |
          cd backend && node dist/app.js > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend health
        run: |
          for i in {1..30}; do
            if curl -sf ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend failed to start"
          cat backend.log || true
          exit 1
      - name: Run health check test
        run: npm run test:api:health
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-api-smoke
          path: backend.log
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi

  build_app:
    needs: lint_typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - run: npm run build

  e2e_smoke:
    name: E2E Smoke
    needs: build_app
    runs-on: ubuntu-latest
    timeout-minutes: 5
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Start full stack
        run: |
          npm run dev > frontend.log 2>&1 &
          echo $! > frontend.pid
          cd backend && node dist/app.js > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for frontend and backend
        run: |
          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -sf ${{ env.FRONTEND_URL }} > /dev/null 2>&1; then
              echo "Frontend is ready"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 2
          done
          echo "Waiting for backend..."
          for i in {1..30}; do
            if curl -sf ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Services failed to start"
          cat frontend.log backend.log || true
          exit 1
      - name: Run E2E health check
        run: npm run test:e2e:health
      - name: Upload full stack logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: full-stack-logs-e2e-smoke
          path: full.log
          retention-days: 7
      - name: Stop full stack
        if: always()
        run: |
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) 2>/dev/null || true
            rm -f frontend.pid
          fi
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          if [ -f full.pid ]; then
            kill $(cat full.pid) 2>/dev/null || true
            rm -f full.pid
          fi

  security_static:
    name: Static Security & Dependencies
    needs: lint_typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Semgrep OWASP
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten
      - name: npm audit high+
        run: npm audit --production --audit-level=high || true
      - name: License check
        run: node nuvana_control/workflows/11-ci_pipeline/scripts/license-check.js

  security_dynamic:
    name: Dynamic Security
    needs: security_static
    runs-on: ubuntu-latest
    timeout-minutes: 10
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npm run prisma:generate
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Start backend
        run: |
          cd backend && node dist/app.js > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend
        run: |
          for i in {1..30}; do
            if curl -sf ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend failed to start"
          cat backend.log || true
          exit 1
      - name: OWASP ZAP baseline
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: ${{ env.BACKEND_URL }}
          cmd_options: "-I"
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-security-dynamic
          path: backend.log
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
