# CI Pipeline - Validation Only (PR-triggered)
# All validation runs on PR; deployment is handled by deploy.yml on push
# SECURITY HARDENED: All secrets in GitHub Secrets, actions pinned to SHAs, artifact signing, log scrubbing

name: CI

on:
  pull_request:
    branches: [main, development]
  schedule:
    - cron: '0 2 * * 0'  # Every Sunday at 2 AM UTC - full test suite
  workflow_dispatch:  # Manual trigger for full test runs

# Default permissions (least privilege)
permissions:
  contents: read

env:
  NODE_VERSION: "20"
  BACKEND_URL: "http://localhost:3001"
  FRONTEND_URL: "http://localhost:3000"
  NEXT_TELEMETRY_DISABLED: "1"
  # Fallback test secrets for CI (only used if repository secrets not configured)
  DEFAULT_TEST_JWT_SECRET: "test-jwt-secret-for-ci-minimum-32-chars-required"
  DEFAULT_TEST_JWT_REFRESH_SECRET: "test-jwt-refresh-secret-for-ci-min-32-chars"
  DEFAULT_TEST_COOKIE_SECRET: "test-cookie-secret-for-ci-minimum-32-characters"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint_typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client for type checking
        run: npm run prisma:generate
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
      - name: Run ESLint
        run: npm run lint 2>&1 | tee lint.log
      - name: Type-check frontend
        run: npx tsc --noEmit 2>&1 | tee typecheck-frontend.log
      - name: Type-check backend
        run: cd backend && npx tsc --noEmit 2>&1 | tee ../typecheck-backend.log
      - name: Upload lint/typecheck logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: lint-typecheck-logs
          path: |
            lint.log
            typecheck-frontend.log
            typecheck-backend.log
          retention-days: 7

  # =============================================================================
  # API Full Test Suite - runs in parallel with E2E
  # =============================================================================
  api_full_suite:
    name: API Full Test Suite
    needs: lint_typecheck
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (root)
        run: npm run prisma:generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed test database
        run: cd backend && npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up port 3001 (if occupied)
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend (built app, test mode)
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000
          UPLOAD_RATE_LIMIT_MAX: 1000
      - name: Start transaction worker (built app, test mode)
        run: |
          cd backend && node dist/workers/transaction.worker.js > ../worker.log 2>&1 &
          echo $! > ../worker.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Wait for backend health
        run: |
          echo "Waiting for backend to be healthy..."
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done
          echo "Backend health check timeout"
          exit 1
      - name: Wait for transaction worker readiness
        run: |
          echo "Waiting for transaction worker to be ready..."
          for i in {1..30}; do
            if grep -q "Transaction worker started successfully" worker.log 2>/dev/null; then
              echo "✅ Transaction worker is ready"
              exit 0
            fi
            if [ -f worker.pid ]; then
              if ! kill -0 $(cat worker.pid) 2>/dev/null; then
                echo "❌ Transaction worker process died"
                echo "Worker logs:"
                cat worker.log || echo "No worker.log found"
                exit 1
              fi
            fi
            echo "Waiting for worker... ($i/30)"
            sleep $((i > 10 ? 3 : 1))
          done
          echo "❌ Transaction worker readiness timeout"
          echo "Worker logs:"
          cat worker.log || echo "No worker.log found"
          exit 1
      - name: Run API test suite
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          CI: "true"
          WORKER_RUNNING: "true"
          BULK_IMPORT_TESTS: "true"
        run: |
          echo "Running API test suite"
          npm run test:api
      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: api-full-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7
      - name: Scrub secrets from logs
        if: failure()
        run: |
          for log_file in backend.log worker.log; do
            if [ -f "$log_file" ]; then
              sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' "$log_file"
              sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' "$log_file"
              sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' "$log_file"
              sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' "$log_file"
              sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' "$log_file"
            fi
          done
      - name: Upload backend and worker logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-api-full
          path: |
            backend.log
            worker.log
          retention-days: 7
      - name: Stop backend and worker
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) 2>/dev/null || true
            rm -f worker.pid
          fi
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  # =============================================================================
  # E2E Full Test Suite - runs in parallel with API
  # =============================================================================
  e2e_full_suite:
    name: E2E Full Test Suite
    needs: lint_typecheck
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (root)
        run: npm run prisma:generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed test database
        run: cd backend && npx prisma db seed
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Cache Playwright browsers
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Build backend
        run: cd backend && npm run build
      - name: Build frontend
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_BACKEND_URL: ${{ env.BACKEND_URL }}
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up ports (if occupied)
        run: |
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000 || true
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true
      - name: Start backend (built app, test mode)
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000
          UPLOAD_RATE_LIMIT_MAX: 1000
      - name: Start transaction worker (built app, test mode)
        run: |
          cd backend && node dist/workers/transaction.worker.js > ../worker.log 2>&1 &
          echo $! > ../worker.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
      - name: Start frontend (production build)
        run: |
          npm run start > frontend.log 2>&1 &
          echo $! > frontend.pid
        env:
          NODE_ENV: production
          NEXT_PUBLIC_BACKEND_URL: ${{ env.BACKEND_URL }}
      - name: Wait for backend health
        run: |
          echo "Waiting for backend to be healthy..."
          for i in {1..30}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is ready"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done
          echo "Backend health check timeout"
          exit 1
      - name: Wait for frontend health
        run: |
          echo "Waiting for frontend to be healthy..."
          for i in {1..30}; do
            if curl -sf --max-time 5 ${{ env.FRONTEND_URL }} > /dev/null 2>&1; then
              echo "Frontend is ready"
              exit 0
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep $((i > 10 ? 5 : 2))
          done
          echo "Frontend health check timeout"
          exit 1
      - name: Wait for transaction worker readiness
        run: |
          echo "Waiting for transaction worker to be ready..."
          for i in {1..30}; do
            if grep -q "Transaction worker started successfully" worker.log 2>/dev/null; then
              echo "✅ Transaction worker is ready"
              exit 0
            fi
            if [ -f worker.pid ]; then
              if ! kill -0 $(cat worker.pid) 2>/dev/null; then
                echo "❌ Transaction worker process died"
                echo "Worker logs:"
                cat worker.log || echo "No worker.log found"
                exit 1
              fi
            fi
            echo "Waiting for worker... ($i/30)"
            sleep $((i > 10 ? 3 : 1))
          done
          echo "❌ Transaction worker readiness timeout"
          echo "Worker logs:"
          cat worker.log || echo "No worker.log found"
          exit 1
      - name: Run E2E test suite
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          CI: "true"
        run: |
          echo "Running E2E test suite"
          npm run test:e2e
      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: e2e-full-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7
      - name: Scrub secrets from logs
        if: failure()
        run: |
          for log_file in backend.log frontend.log worker.log; do
            if [ -f "$log_file" ]; then
              sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' "$log_file"
              sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' "$log_file"
              sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' "$log_file"
              sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' "$log_file"
              sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' "$log_file"
            fi
          done
      - name: Upload backend, frontend, and worker logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-e2e-full
          path: |
            backend.log
            frontend.log
            worker.log
          retention-days: 7
      - name: Stop backend, frontend, and worker
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) 2>/dev/null || true
            rm -f frontend.pid
          fi
          if [ -f worker.pid ]; then
            kill $(cat worker.pid) 2>/dev/null || true
            rm -f worker.pid
          fi
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3000 || true
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  component_tests:
    name: Component Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Run component tests
        run: npm run test:component -- --reporter=dot -- --coverage 2>&1 | tee component-tests.log
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          CI: "true"
      - name: Upload component coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: coverage-component
          path: coverage
          retention-days: 7
      - name: Upload component test results (includes slow tests)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: component-test-results
          path: |
            component-tests.log
            test-results/vitest-results.json
          retention-days: 7

  unit_integration_tests:
    name: Unit & Integration Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            package-lock.json
            backend/package-lock.json
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed RBAC roles
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run unit tests
        run: npm run test:unit -- --coverage 2>&1 | tee unit-tests.log
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          CI: "true"
      - name: Run integration tests
        run: npm run test:integration 2>&1 | tee integration-tests.log
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          CI: "true"
      - name: Upload unit coverage
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: coverage-unit
          path: coverage
          retention-days: 7
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: unit-integration-test-results
          path: |
            unit-tests.log
            integration-tests.log
            test-results/vitest-results.json
          retention-days: 7

  api_tests:
    name: API Tests
    needs: lint_typecheck
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed roles for auth
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up port 3001 (if occupied)
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend (built app, test mode)
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000
          UPLOAD_RATE_LIMIT_MAX: 1000
      - name: Wait for backend health
        id: wait_backend_api_smoke
        run: |
          echo "Waiting for backend to be healthy (checking /api/health)..."
          for i in {1..60}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is healthy and ready"
              echo "health_check_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for backend health check... ($i/60)"
            sleep $((i > 20 ? 5 : 3))
          done
          echo "Backend health check failed after 3 minutes"
          echo "health_check_passed=false" >> $GITHUB_OUTPUT
          echo "Backend logs:"
          cat backend.log || true
          exit 1
      - name: Run health check test
        if: steps.wait_backend_api_smoke.outputs.health_check_passed == 'true'
        env:
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: npm run test:api:health
      - name: Scrub secrets from logs
        if: failure()
        run: |
          if [ -f backend.log ]; then
            sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' backend.log
            sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' backend.log
            sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' backend.log
            sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' backend.log
            sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' backend.log
          fi
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-api-smoke
          path: backend.log
          retention-days: 7
      - name: Upload API test results (includes slow tests)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: api-smoke-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  build_app:
    name: Build Application
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Build application
        run: npm run build 2>&1 | tee build.log
      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: build-logs
          path: build.log
          retention-days: 7

  security_static:
    name: Static Security & Dependencies
    needs: lint_typecheck
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
        with:
          fetch-depth: 0
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Semgrep OWASP
        uses: semgrep/semgrep-action@v1
        with:
          config: p/owasp-top-ten
      - name: npm audit (high severity)
        run: npm audit --omit=dev --audit-level=high
      - name: npm audit (high severity - backend)
        run: cd backend && npm audit --omit=dev --audit-level=high
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Generate SBOM (CycloneDX)
        uses: CycloneDX/gh-node-module-generatebom@27e13c2bf0fae78d66387b35ca9749d8cc853060  # v1.0.3
        with:
          output: sbom.xml
      - name: Upload SBOM
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: sbom-node
          path: sbom.xml
          retention-days: 30
      - name: License check
        run: node nuvana_control/workflows/11-ci_pipeline/scripts/license-check.js

  security_dynamic:
    name: Dynamic Security
    needs: security_static
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
    permissions:
      contents: read
      issues: write
      security-events: write
    services:
      postgres:
        image: postgres:15.14
        env:
          POSTGRES_DB: nuvana_test
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5
      rabbitmq:
        image: rabbitmq:3.13-management
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd="rabbitmq-diagnostics -q ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Generate Prisma Client (backend)
        run: cd backend && npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Seed roles for auth
        run: npx tsx backend/src/db/seeds/rbac.seed.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Bootstrap admin user
        run: npx tsx backend/scripts/bootstrap-admin.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Clean test database
        run: npx tsx scripts/cleanup-test-data.ts
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
      - name: Build backend
        run: cd backend && npm run build
      - name: Make scripts executable
        run: chmod +x nuvana_control/workflows/11-ci_pipeline/scripts/*.sh
      - name: Clean up port 3001 (if occupied)
        run: bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001
      - name: Start backend (built app, test mode)
        run: |
          cd backend && npm run start:test > ../backend.log 2>&1 &
          echo $! > ../backend.pid
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres@localhost:5432/nuvana_test
          REDIS_URL: redis://localhost:6379
          RABBITMQ_URL: amqp://guest:guest@localhost:5672
          JWT_SECRET: ${{ secrets.TEST_JWT_SECRET || env.DEFAULT_TEST_JWT_SECRET }}
          JWT_REFRESH_SECRET: ${{ secrets.TEST_JWT_REFRESH_SECRET || env.DEFAULT_TEST_JWT_REFRESH_SECRET }}
          COOKIE_SECRET: ${{ secrets.TEST_COOKIE_SECRET || env.DEFAULT_TEST_COOKIE_SECRET }}
          DAILY_UPLOAD_COUNT: 1000
          UPLOAD_RATE_LIMIT_MAX: 1000
      - name: Wait for backend
        id: wait_backend
        run: |
          echo "Waiting for backend to be healthy (checking /api/health)..."
          for i in {1..60}; do
            if curl -sf --max-time 5 --retry 2 ${{ env.BACKEND_URL }}/api/health > /dev/null 2>&1; then
              echo "Backend is healthy and ready"
              echo "health_check_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "Waiting for backend health check... ($i/60)"
            sleep $((i > 20 ? 5 : 3))
          done
          echo "Backend health check failed after 3 minutes"
          echo "health_check_passed=false" >> $GITHUB_OUTPUT
          echo "Backend logs:"
          cat backend.log || true
          exit 1
      - name: Obtain auth cookies
        if: steps.wait_backend.outputs.health_check_passed == 'true'
        id: zap_auth
        run: |
          RESPONSE_HEADERS=$(curl -i -s -X POST "${{ env.BACKEND_URL }}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@nuvana.com","password":"Admin123!"}')
          COOKIES=$(echo "$RESPONSE_HEADERS" | grep -i '^set-cookie:' | cut -d' ' -f2- | cut -d';' -f1 | tr '\n' '; ' | sed 's/; $//')
          if [ -z "$COOKIES" ]; then
            echo "Failed to retrieve auth cookies"
            exit 1
          fi
          echo "cookie_header=$COOKIES" >> $GITHUB_OUTPUT
      - name: OWASP ZAP baseline (authenticated)
        if: steps.wait_backend.outputs.health_check_passed == 'true' && steps.zap_auth.outputs.cookie_header
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25  # v0.15.0
        with:
          target: ${{ env.BACKEND_URL }}
          fail_action: true
          artifact_name: zap-scan-report
          rules_file_name: '.zap/rules.tsv'
          cmd_options: "-I -z \"-config replacer.full_list(0).description=auth-cookies -config replacer.full_list(0).enabled=true -config replacer.full_list(0).matchtype=REQ_HEADER -config replacer.full_list(0).matchstr=Cookie -config replacer.full_list(0).replacement=${{ steps.zap_auth.outputs.cookie_header }}\""
      - name: Scrub secrets from logs
        if: failure()
        run: |
          if [ -f backend.log ]; then
            sed -i 's/Bearer [A-Za-z0-9._-]*/Bearer [REDACTED]/g' backend.log
            sed -i 's/"token":"[^"]*"/"token":"[REDACTED]"/g' backend.log
            sed -i 's/"password":"[^"]*"/"password":"[REDACTED]"/g' backend.log
            sed -i 's/"secret":"[^"]*"/"secret":"[REDACTED]"/g' backend.log
            sed -i 's/postgresql:\/\/[^@]*@/postgresql:\/\/[REDACTED]@/g' backend.log
          fi
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: backend-logs-security-dynamic
          path: backend.log
          retention-days: 7
      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) 2>/dev/null || true
            rm -f backend.pid
          fi
          bash nuvana_control/workflows/11-ci_pipeline/scripts/kill-port.sh 3001 || true

  artifact_build:
    name: Build & Upload Artifacts
    needs: build_app
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
      - run: npm ci
      - name: Install backend dependencies
        run: cd backend && npm ci
      - name: Build frontend
        run: npm run build
      - name: Validate build output
        run: |
          if [ ! -d ".next" ]; then
            echo "::error::Frontend build failed - .next directory not found"
            exit 1
          fi
          echo "✅ Frontend build output validated"
          du -sh .next/
      - name: Create attestation archive
        run: |
          tar -czf frontend-build.tar.gz .next/
          echo "✅ Created frontend-build.tar.gz ($(du -h frontend-build.tar.gz | cut -f1))"
      - name: Generate build provenance attestation
        uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c  # v1.4.3
        with:
          subject-path: |
            frontend-build.tar.gz
      - name: Upload bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: build-output
          path: |
            .next
            package-lock.json
          retention-days: 30

  bundle_security_scan:
    name: Bundle Vulnerability Scan
    needs: artifact_build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      - name: Download build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6.0.0
        with:
          name: build-output
          path: ./build-output
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1  # v0.2.4
        with:
          version: 'v0.68.1'
      - name: Run Trivy vulnerability scanner (blocking - HIGH/CRITICAL with fixes)
        id: trivy_blocking
        run: |
          trivy fs ./build-output \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --ignorefile .trivyignore.yaml \
            --format sarif \
            --output trivy-bundle-results.sarif \
            --exit-code 1
        continue-on-error: true
      - name: Run Trivy full scan (informational - all severities)
        if: always()
        run: |
          trivy fs ./build-output \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --ignorefile .trivyignore.yaml \
            --format json \
            --output trivy-full-report.json \
            --exit-code 0
      - name: Generate human-readable report
        if: always()
        run: |
          trivy fs ./build-output \
            --severity HIGH,CRITICAL \
            --ignorefile .trivyignore.yaml \
            --format table \
            --show-suppressed \
            --output trivy-report.txt \
            --exit-code 0
          echo "=== Trivy Scan Summary ===" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7  # v4.31.9
        if: always() && hashFiles('trivy-bundle-results.sarif') != ''
        with:
          sarif_file: 'trivy-bundle-results.sarif'
      - name: Upload Trivy results artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: trivy-bundle-scan
          path: |
            trivy-bundle-results.sarif
            trivy-full-report.json
            trivy-report.txt
          retention-days: 30
      - name: Fail if blocking vulnerabilities found
        if: steps.trivy_blocking.outcome == 'failure'
        run: |
          echo "::error::Trivy found HIGH/CRITICAL vulnerabilities with available fixes"
          echo "Review trivy-report.txt artifact for details"
          echo "If these are false positives, document them in .trivyignore.yaml with justification"
          exit 1
