// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id          String   @id @default(uuid()) @db.Uuid
  public_id        String?  @unique @db.VarChar(30) // usr_xxxxx (external-facing ID)
  email            String   @unique @db.VarChar(255)
  name             String   @db.VarChar(255)
  password_hash    String?  @db.VarChar(255)
  auth_provider_id String?  @unique @db.VarChar(255)
  status           String   @default("ACTIVE") @db.VarChar(50)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  user_roles     UserRole[]
  assigned_roles UserRole[] @relation("UserRoleAssigner")
  audit_logs     AuditLog[]
  shifts         Shift[]    @relation("ShiftCashier")
  transactions   Transaction[] @relation("TransactionCashier")

  @@index([email])
  @@index([status])
  @@index([public_id])
  @@map("users")
}

model Client {
  client_id  String    @id @default(uuid()) @db.Uuid
  public_id  String?   @unique @db.VarChar(30) // clt_xxxxx (external-facing ID)
  name       String    @db.VarChar(255)
  status     String    @default("ACTIVE") @db.VarChar(50) // ACTIVE | INACTIVE
  metadata   Json?     @db.JsonB
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  companies  Company[]
  user_roles UserRole[]

  @@index([status])
  @@index([deleted_at])
  @@index([public_id])
  @@map("clients")
}

model Company {
  company_id String    @id @default(uuid()) @db.Uuid
  public_id  String?   @unique @db.VarChar(30) // cmp_xxxxx (external-facing ID)
  client_id  String?   @db.Uuid
  name       String    @db.VarChar(255)
  status     String    @default("ACTIVE") @db.VarChar(50)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  deleted_at DateTime? @db.Timestamptz(6)

  client     Client?    @relation(fields: [client_id], references: [client_id], onDelete: SetNull)
  stores     Store[]
  user_roles UserRole[]

  @@index([client_id])
  @@index([status])
  @@index([public_id])
  @@map("companies")
}

model Store {
  store_id      String   @id @default(uuid()) @db.Uuid
  public_id     String?  @unique @db.VarChar(30) // str_xxxxx (external-facing ID)
  company_id    String   @db.Uuid
  name          String   @db.VarChar(255)
  location_json Json?    @db.JsonB
  timezone      String   @default("America/New_York") @db.VarChar(50)
  configuration Json?    @db.JsonB
  status        String   @default("ACTIVE") @db.VarChar(50)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  company       Company       @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  user_roles    UserRole[]
  shifts        Shift[]
  pos_terminals POSTerminal[]
  transactions  Transaction[]

  @@index([company_id])
  @@index([status])
  @@index([public_id])
  @@map("stores")
}

model Role {
  role_id     String   @id @default(uuid()) @db.Uuid
  scope       String   @db.VarChar(50) // SYSTEM | COMPANY | STORE
  code        String   @unique @db.VarChar(100) // SUPERADMIN | CORPORATE_ADMIN | STORE_MANAGER | etc.
  description String?  @db.Text
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  user_roles       UserRole[]
  role_permissions RolePermission[]

  @@index([scope])
  @@index([code])
  @@map("roles")
}

model Permission {
  permission_id String   @id @default(uuid()) @db.Uuid
  code          String   @unique @db.VarChar(100) // USER_CREATE | SHIFT_OPEN | etc.
  description   String?  @db.Text
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  role_permissions RolePermission[]

  @@index([code])
  @@map("permissions")
}

model UserRole {
  user_role_id String   @id @default(uuid()) @db.Uuid
  user_id      String   @db.Uuid
  role_id      String   @db.Uuid
  client_id    String?  @db.Uuid
  company_id   String?  @db.Uuid
  store_id     String?  @db.Uuid
  assigned_by  String?  @db.Uuid
  assigned_at  DateTime @default(now()) @db.Timestamptz(6)

  user     User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role     Role     @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  client   Client?  @relation(fields: [client_id], references: [client_id], onDelete: Cascade)
  company  Company? @relation(fields: [company_id], references: [company_id], onDelete: Cascade)
  store    Store?   @relation(fields: [store_id], references: [store_id], onDelete: Cascade)
  assigner User?    @relation("UserRoleAssigner", fields: [assigned_by], references: [user_id])

  @@unique([user_id, role_id, client_id, company_id, store_id])
  @@index([user_id])
  @@index([client_id])
  @@index([company_id])
  @@index([store_id])
  @@map("user_roles")
}

model RolePermission {
  role_id       String @db.Uuid
  permission_id String @db.Uuid

  role       Role       @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [permission_id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@index([role_id])
  @@index([permission_id])
  @@map("role_permissions")
}

model AuditLog {
  log_id     String   @id @default(uuid()) @db.Uuid
  user_id    String?  @db.Uuid
  action     String   @db.VarChar(50) // CREATE | UPDATE | DELETE | OVERRIDE | PERMISSION_DENIED
  table_name String   @db.VarChar(100)
  record_id  String   @db.Uuid
  old_values Json?    @db.JsonB
  new_values Json?    @db.JsonB
  reason     String?  @db.Text
  ip_address String?  @db.VarChar(45) // IPv4 or IPv6 address
  user_agent String?  @db.Text
  timestamp  DateTime @default(now()) @db.Timestamptz(6)

  user User? @relation(fields: [user_id], references: [user_id])

  @@index([user_id])
  @@index([table_name])
  @@index([timestamp])
  @@map("audit_logs")
}

model Shift {
  shift_id        String    @id @default(uuid()) @db.Uuid
  public_id       String?   @unique @db.VarChar(30) // sft_xxxxx (external-facing ID)
  store_id        String    @db.Uuid
  cashier_id      String    @db.Uuid
  pos_terminal_id String?   @db.Uuid
  start_time      DateTime  @default(now()) @db.Timestamptz(6)
  end_time        DateTime? @db.Timestamptz(6)
  opening_amount  Decimal   @default(0) @db.Decimal(10, 2)
  closing_amount  Decimal?  @db.Decimal(10, 2)
  status          String    @default("OPEN") @db.VarChar(50) // OPEN | CLOSED | RECONCILED
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  store        Store         @relation(fields: [store_id], references: [store_id], onDelete: Cascade)
  cashier      User          @relation("ShiftCashier", fields: [cashier_id], references: [user_id])
  pos_terminal POSTerminal?  @relation(fields: [pos_terminal_id], references: [pos_terminal_id])
  transactions Transaction[]

  @@index([store_id])
  @@index([cashier_id])
  @@index([pos_terminal_id])
  @@index([status])
  @@index([start_time])
  @@index([public_id])
  @@map("shifts")
}

model POSTerminal {
  pos_terminal_id String   @id @default(uuid()) @db.Uuid
  store_id        String   @db.Uuid
  name            String   @db.VarChar(100)
  device_id       String?  @db.VarChar(255)
  status          String   @default("ACTIVE") @db.VarChar(50) // ACTIVE | INACTIVE | MAINTENANCE
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  store        Store         @relation(fields: [store_id], references: [store_id], onDelete: Cascade)
  shifts       Shift[]
  transactions Transaction[]

  @@index([store_id])
  @@index([status])
  @@map("pos_terminals")
}

model Transaction {
  transaction_id  String   @id @default(uuid()) @db.Uuid
  public_id       String?  @unique @db.VarChar(30) // txn_xxxxx (external-facing ID)
  store_id        String   @db.Uuid
  shift_id        String   @db.Uuid
  cashier_id      String   @db.Uuid
  pos_terminal_id String?  @db.Uuid
  timestamp       DateTime @default(now()) @db.Timestamptz(6)
  subtotal        Decimal  @db.Decimal(10, 2)
  tax             Decimal  @default(0) @db.Decimal(10, 2)
  discount        Decimal  @default(0) @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(10, 2)
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  store        Store                 @relation(fields: [store_id], references: [store_id], onDelete: Cascade)
  shift        Shift                 @relation(fields: [shift_id], references: [shift_id])
  cashier      User                  @relation("TransactionCashier", fields: [cashier_id], references: [user_id])
  pos_terminal POSTerminal?          @relation(fields: [pos_terminal_id], references: [pos_terminal_id])
  line_items   TransactionLineItem[]
  payments     TransactionPayment[]

  @@index([store_id])
  @@index([shift_id])
  @@index([cashier_id])
  @@index([pos_terminal_id])
  @@index([timestamp])
  @@index([public_id])
  @@map("transactions")
}

model TransactionLineItem {
  line_item_id   String   @id @default(uuid()) @db.Uuid
  transaction_id String   @db.Uuid
  product_id     String?  @db.Uuid
  sku            String?  @db.VarChar(100)
  name           String   @db.VarChar(255)
  quantity       Int
  unit_price     Decimal  @db.Decimal(10, 2)
  discount       Decimal  @default(0) @db.Decimal(10, 2)
  line_total     Decimal  @db.Decimal(10, 2)
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  transaction Transaction @relation(fields: [transaction_id], references: [transaction_id], onDelete: Cascade)

  @@index([transaction_id])
  @@index([product_id])
  @@map("transaction_line_items")
}

model TransactionPayment {
  payment_id     String   @id @default(uuid()) @db.Uuid
  transaction_id String   @db.Uuid
  method         String   @db.VarChar(50) // CASH | CREDIT | DEBIT | EBT | OTHER
  amount         Decimal  @db.Decimal(10, 2)
  reference      String?  @db.VarChar(100) // Last 4 digits for cards
  created_at     DateTime @default(now()) @db.Timestamptz(6)

  transaction Transaction @relation(fields: [transaction_id], references: [transaction_id], onDelete: Cascade)

  @@index([transaction_id])
  @@map("transaction_payments")
}
