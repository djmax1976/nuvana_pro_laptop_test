"use client";

/**
 * POS Integration Page
 *
 * Displays the POS Integration setup wizard or configured status view
 * based on whether the store has an existing POS integration.
 *
 * Reference: nuvana_docs/plans/POS-Onboarding-Plan-with-UI.md Phase 4
 *
 * @module app/(mystore)/mystore/pos-integration/page
 */

import { useClientDashboard } from "@/lib/api/client-dashboard";
import { usePOSIntegration } from "@/lib/api/pos-integration";
import { POSSetupWizard } from "@/components/pos-integration";
import { Loader2 } from "lucide-react";

/**
 * POS Integration Page Component
 *
 * Flow:
 * 1. Fetches store data from client dashboard
 * 2. Checks if store has existing POS integration
 * 3. Shows setup wizard if no integration, or configured view if exists
 *
 * @returns POS Integration page with wizard or configured view
 */
export default function POSIntegrationPage(): JSX.Element {
  // Get store ID from dashboard data
  const { data: dashboardData, isLoading: dashboardLoading } =
    useClientDashboard();

  // Get first active store
  const storeId =
    dashboardData?.stores.find((s) => s.status === "ACTIVE")?.store_id ||
    dashboardData?.stores[0]?.store_id;

  // Check if store has POS integration
  const {
    data: integration,
    isLoading: integrationLoading,
    isError: integrationError,
  } = usePOSIntegration(storeId || "", {
    enabled: !!storeId,
  });

  // Loading state
  if (dashboardLoading || integrationLoading) {
    return (
      <div className="flex h-[50vh] items-center justify-center">
        <div className="text-center">
          <Loader2 className="h-8 w-8 animate-spin text-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Loading POS Integration...</p>
        </div>
      </div>
    );
  }

  // No store found
  if (!storeId) {
    return (
      <div className="flex h-[50vh] items-center justify-center">
        <div className="text-center">
          <p className="text-muted-foreground">
            No store found. Please contact support.
          </p>
        </div>
      </div>
    );
  }

  // Show setup wizard if no integration exists or error (404 = no integration)
  // The API returns error when no integration is configured
  const hasIntegration = integration && !integrationError;

  if (!hasIntegration) {
    return (
      <div className="container max-w-4xl mx-auto py-8">
        <POSSetupWizard
          storeId={storeId}
          onComplete={() => {
            // Reload to show configured view
            window.location.reload();
          }}
        />
      </div>
    );
  }

  // TODO: Phase 3 - Show ConfiguredStatusView when integration exists
  // For now, show a basic status message
  return (
    <div className="container max-w-4xl mx-auto py-8">
      <div className="bg-white rounded-lg shadow-sm border p-6">
        <h1 className="text-xl font-semibold text-gray-800 mb-4">
          POS Integration
        </h1>
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <p className="text-green-800 font-medium">
            POS Integration is configured
          </p>
          <p className="text-green-600 text-sm mt-1">
            System: {integration.pos_type}
          </p>
          <p className="text-green-600 text-sm">
            Status: {integration.is_active ? "Active" : "Inactive"}
          </p>
        </div>
      </div>
    </div>
  );
}
