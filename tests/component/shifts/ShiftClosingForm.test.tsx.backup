/**
 * @test-level Component
 * @justification Component tests for ShiftClosingForm - validates closing initiation, reconciliation flow, and variance threshold logic
 * @story 4-7-shift-management-ui
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import {
  renderWithProviders,
  screen,
  waitFor,
} from "../../support/test-utils";
import { ShiftClosingForm } from "@/components/shifts/ShiftClosingForm";
import * as shiftsApi from "@/lib/api/shifts";
import userEvent from "@testing-library/user-event";

// Mock the API hooks
vi.mock("@/lib/api/shifts", () => ({
  useCloseShift: vi.fn(),
  useReconcileCash: vi.fn(),
  useInvalidateShifts: vi.fn(),
}));

// Mock toast hook
vi.mock("@/hooks/use-toast", () => ({
  useToast: () => ({
    toast: vi.fn(),
  }),
}));

describe("4.7-COMPONENT: ShiftClosingForm Component", () => {
  const mockShiftId = "shift-123";

  const mockCloseShiftMutation = {
    mutateAsync: vi.fn(),
    isPending: false,
  };

  const mockReconcileCashMutation = {
    mutateAsync: vi.fn(),
    isPending: false,
  };

  const mockInvalidate = {
    invalidateList: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(shiftsApi.useCloseShift).mockReturnValue(mockCloseShiftMutation as any);
    vi.mocked(shiftsApi.useReconcileCash).mockReturnValue(mockReconcileCashMutation as any);
    vi.mocked(shiftsApi.useInvalidateShifts).mockReturnValue(mockInvalidate as any);
  });

  it("[P0] 4.7-COMPONENT-040: should render initiate closing step when open", () => {
    // GIVEN: Component is rendered with open=true
    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Initiate closing button should be displayed
    expect(screen.getByTestId("initiate-closing-button")).toBeInTheDocument();
    expect(screen.getByText(/close shift/i)).toBeInTheDocument();
  });

  it("[P0] 4.7-COMPONENT-041: should initiate closing when button is clicked", async () => {
    // GIVEN: Component is rendered and close shift succeeds
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        expected_cash: 245.0,
        opening_cash: 100.0,
        cash_transactions_total: 145.0,
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Initiate closing button is clicked
    const initiateButton = screen.getByTestId("initiate-closing-button");
    await user.click(initiateButton);

    // THEN: Close shift mutation should be called
    await waitFor(() => {
      expect(mockCloseShiftMutation.mutateAsync).toHaveBeenCalledWith(mockShiftId);
    });
  });

  it("[P0] 4.7-COMPONENT-042: should display reconciliation form after closing initiated", async () => {
    // GIVEN: Component is rendered and closing is initiated
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        expected_cash: 245.0,
        opening_cash: 100.0,
        cash_transactions_total: 145.0,
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Closing is initiated
    const initiateButton = screen.getByTestId("initiate-closing-button");
    await user.click(initiateButton);

    // THEN: Reconciliation form should be displayed
    await waitFor(() => {
      expect(screen.getByTestId("expected-cash-display")).toBeInTheDocument();
      expect(screen.getByTestId("actual-cash-input")).toBeInTheDocument();
    });
  });

  it("[P0] 4.7-COMPONENT-043: should calculate and display variance", async () => {
    // GIVEN: Component is in reconciliation step
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        expected_cash: 245.0,
        opening_cash: 100.0,
        cash_transactions_total: 145.0,
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Closing is initiated and actual cash is entered
    await user.click(screen.getByTestId("initiate-closing-button"));
    await waitFor(() => {
      expect(screen.getByTestId("actual-cash-input")).toBeInTheDocument();
    });

    const actualCashInput = screen.getByTestId("actual-cash-input");
    await user.type(actualCashInput, "250");

    // THEN: Variance should be calculated and displayed
    await waitFor(() => {
      expect(screen.getByTestId("variance-amount-display")).toBeInTheDocument();
      expect(screen.getByTestId("variance-percentage-display")).toBeInTheDocument();
    });
  });

  it("[P0] 4.7-COMPONENT-044: should display variance alert when threshold exceeded", async () => {
    // GIVEN: Component is in reconciliation step with variance > $5
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        expected_cash: 100.0,
        opening_cash: 50.0,
        cash_transactions_total: 50.0,
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Closing is initiated and actual cash creates variance > $5
    await user.click(screen.getByTestId("initiate-closing-button"));
    await waitFor(() => {
      expect(screen.getByTestId("actual-cash-input")).toBeInTheDocument();
    });

    const actualCashInput = screen.getByTestId("actual-cash-input");
    await user.type(actualCashInput, "110"); // Variance = $10 > $5 threshold

    // THEN: Variance alert should be displayed
    await waitFor(() => {
      expect(screen.getByTestId("variance-alert")).toBeInTheDocument();
      expect(screen.getByText(/variance exceeds threshold/i)).toBeInTheDocument();
    });
  });

  it("[P0] 4.7-COMPONENT-045: should submit reconciliation with valid data", async () => {
    // GIVEN: Component is in reconciliation step
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        expected_cash: 245.0,
        opening_cash: 100.0,
        cash_transactions_total: 145.0,
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    mockReconcileCashMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "RECONCILING",
        closing_cash: 250.0,
        expected_cash: 245.0,
        variance_amount: 5.0,
        variance_percentage: 2.04,
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Closing is initiated, actual cash entered, and form submitted
    await user.click(screen.getByTestId("initiate-closing-button"));
    await waitFor(() => {
      expect(screen.getByTestId("actual-cash-input")).toBeInTheDocument();
    });

    const actualCashInput = screen.getByTestId("actual-cash-input");
    await user.type(actualCashInput, "250");

    const submitButton = screen.getByTestId("submit-reconciliation");
    await user.click(submitButton);

    // THEN: Reconcile cash mutation should be called
    await waitFor(() => {
      expect(mockReconcileCashMutation.mutateAsync).toHaveBeenCalledWith({
        shiftId: mockShiftId,
        data: {
          closing_cash: 250,
          variance_reason: undefined,
        },
      });
    });
  });

  it("[P0] 4.7-COMPONENT-046: should validate closing cash is positive", async () => {
    // GIVEN: Component is in reconciliation step
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShiftId,
        status: "CLOSING",
        expected_cash: 245.0,
        opening_cash: 100.0,
        cash_transactions_total: 145.0,
        closing_initiated_at: "2024-01-01T10:00:00Z",
        closing_initiated_by: "user-1",
        calculated_at: "2024-01-01T10:00:00Z",
      },
    });

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Closing is initiated and invalid cash amount is entered
    await user.click(screen.getByTestId("initiate-closing-button"));
    await waitFor(() => {
      expect(screen.getByTestId("actual-cash-input")).toBeInTheDocument();
    });

    const actualCashInput = screen.getByTestId("actual-cash-input");
    await user.type(actualCashInput, "0");

    const submitButton = screen.getByTestId("submit-reconciliation");
    await user.click(submitButton);

    // THEN: Validation error should be displayed
    await waitFor(() => {
      expect(screen.getByText(/closing cash must be a positive number/i)).toBeInTheDocument();
    });
  });

  it("[P1] 4.7-COMPONENT-047: should handle closing initiation errors", async () => {
    // GIVEN: Component is rendered and close shift fails
    const user = userEvent.setup();
    mockCloseShiftMutation.mutateAsync.mockRejectedValue(
      new Error("SHIFT_NOT_FOUND: Shift not found"),
    );

    renderWithProviders(
      <ShiftClosingForm
        shiftId={mockShiftId}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Initiate closing button is clicked
    const initiateButton = screen.getByTestId("initiate-closing-button");
    await user.click(initiateButton);

    // THEN: Error should be handled (toast notification would be shown)
    await waitFor(() => {
      expect(mockCloseShiftMutation.mutateAsync).toHaveBeenCalled();
    });
  });
});

