/**
 * @test-level Component
 * @justification Component tests for VarianceApprovalDialog - validates variance approval flow with required reason
 * @story 4-7-shift-management-ui
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import {
  renderWithProviders,
  screen,
  waitFor,
} from "../../support/test-utils";
import { VarianceApprovalDialog } from "@/components/shifts/VarianceApprovalDialog";
import * as shiftsApi from "@/lib/api/shifts";
import type { ShiftResponse } from "@/lib/api/shifts";
import userEvent from "@testing-library/user-event";

// Mock the API hooks
vi.mock("@/lib/api/shifts", () => ({
  useReconcileCash: vi.fn(),
  useInvalidateShifts: vi.fn(),
}));

// Mock toast hook
vi.mock("@/hooks/use-toast", () => ({
  useToast: () => ({
    toast: vi.fn(),
  }),
}));

describe("4.7-COMPONENT: VarianceApprovalDialog Component", () => {
  const mockShift: ShiftResponse = {
    shift_id: "shift-123",
    store_id: "store-1",
    opened_by: "user-1",
    cashier_id: "cashier-1",
    pos_terminal_id: "terminal-1",
    status: "VARIANCE_REVIEW",
    opening_cash: 100.0,
    closing_cash: 200.0,
    expected_cash: 180.0,
    variance_amount: 20.0,
    variance_percentage: 11.11,
    opened_at: "2024-01-01T10:00:00Z",
    closed_at: "2024-01-01T18:00:00Z",
    store_name: "Store 1",
    cashier_name: "John Doe",
  };

  const mockReconcileCashMutation = {
    mutateAsync: vi.fn(),
    isPending: false,
  };

  const mockInvalidate = {
    invalidateList: vi.fn(),
  };

  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(shiftsApi.useReconcileCash).mockReturnValue(mockReconcileCashMutation as any);
    vi.mocked(shiftsApi.useInvalidateShifts).mockReturnValue(mockInvalidate as any);
  });

  it("[P0] 4.7-COMPONENT-050: should render dialog when open is true", () => {
    // GIVEN: Component is rendered with open=true
    renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Dialog should be visible
    expect(screen.getByText("Approve Variance")).toBeInTheDocument();
    expect(screen.getByTestId("variance-reason-input")).toBeInTheDocument();
  });

  it("[P0] 4.7-COMPONENT-051: should display variance amount and percentage prominently", () => {
    // GIVEN: Component is rendered with shift having variance
    renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Variance details should be displayed
    expect(screen.getByTestId("variance-alert")).toBeInTheDocument();
    expect(screen.getByTestId("variance-amount-display")).toBeInTheDocument();
    expect(screen.getByTestId("variance-percentage-display")).toBeInTheDocument();
  });

  it("[P0] 4.7-COMPONENT-052: should require variance reason", async () => {
    // GIVEN: Component is rendered
    const user = userEvent.setup();
    renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Form is submitted without variance reason
    const submitButton = screen.getByTestId("submit-variance-approval");
    await user.click(submitButton);

    // THEN: Validation error should be displayed
    await waitFor(() => {
      expect(screen.getByText(/variance reason is required/i)).toBeInTheDocument();
    });
  });

  it("[P0] 4.7-COMPONENT-053: should submit approval with valid reason", async () => {
    // GIVEN: Component is rendered and mutation succeeds
    const user = userEvent.setup();
    mockReconcileCashMutation.mutateAsync.mockResolvedValue({
      success: true,
      data: {
        shift_id: mockShift.shift_id,
        status: "CLOSED",
        closing_cash: mockShift.closing_cash,
        expected_cash: mockShift.expected_cash,
        variance_amount: mockShift.variance_amount,
        variance_percentage: mockShift.variance_percentage,
        variance_reason: "Cash handling error",
        approved_by: "user-1",
        approved_at: "2024-01-01T19:00:00Z",
        closed_at: "2024-01-01T19:00:00Z",
      },
    });

    renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Variance reason is entered and form is submitted
    const reasonInput = screen.getByTestId("variance-reason-input");
    await user.type(reasonInput, "Cash handling error during shift");

    const submitButton = screen.getByTestId("submit-variance-approval");
    await user.click(submitButton);

    // THEN: Reconcile cash mutation should be called with variance reason
    await waitFor(() => {
      expect(mockReconcileCashMutation.mutateAsync).toHaveBeenCalledWith({
        shiftId: mockShift.shift_id,
        data: {
          variance_reason: "Cash handling error during shift",
        },
      });
    });
  });

  it("[P0] 4.7-COMPONENT-054: should handle approval errors", async () => {
    // GIVEN: Component is rendered and mutation fails
    const user = userEvent.setup();
    mockReconcileCashMutation.mutateAsync.mockRejectedValue(
      new Error("SHIFT_NOT_VARIANCE_REVIEW: Shift is not in VARIANCE_REVIEW status"),
    );

    renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // WHEN: Form is submitted with valid reason
    const reasonInput = screen.getByTestId("variance-reason-input");
    await user.type(reasonInput, "Test reason");

    const submitButton = screen.getByTestId("submit-variance-approval");
    await user.click(submitButton);

    // THEN: Error should be handled (toast notification would be shown)
    await waitFor(() => {
      expect(mockReconcileCashMutation.mutateAsync).toHaveBeenCalled();
    });
  });

  it("[P1] 4.7-COMPONENT-055: should reset form when dialog closes", async () => {
    // GIVEN: Component is rendered and form has values
    const user = userEvent.setup();
    const onOpenChange = vi.fn();
    const { rerender } = renderWithProviders(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={onOpenChange}
      />,
    );

    const reasonInput = screen.getByTestId("variance-reason-input");
    await user.type(reasonInput, "Test reason");

    // WHEN: Dialog is closed and reopened
    await user.click(screen.getByRole("button", { name: /cancel/i }));
    expect(onOpenChange).toHaveBeenCalledWith(false);

    rerender(
      <VarianceApprovalDialog
        shift={mockShift}
        open={true}
        onOpenChange={onOpenChange}
      />,
    );

    // THEN: Form should be reset
    const newReasonInput = screen.getByTestId("variance-reason-input");
    expect(newReasonInput).toHaveValue("");
  });
});

