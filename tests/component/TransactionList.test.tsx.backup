/**
 * @test-level Component
 * @justification Component tests for TransactionList - validates rendering, loading states, error handling, and empty states
 * @story 3-5-transaction-display-ui
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { renderWithProviders, screen, waitFor } from "../support/test-utils";
import { TransactionList } from "@/components/transactions/TransactionList";
import * as transactionsApi from "@/lib/api/transactions";
import type { Transaction, TransactionQueryResult } from "@/lib/api/transactions";

// Mock Next.js Link component
vi.mock("next/link", () => ({
  default: ({
    children,
    href,
  }: {
    children: React.ReactNode;
    href: string;
  }) => <a href={href}>{children}</a>,
}));

// Mock Next.js navigation
vi.mock("next/navigation", () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    back: vi.fn(),
    forward: vi.fn(),
    refresh: vi.fn(),
    prefetch: vi.fn(),
  }),
  usePathname: () => "/",
  useSearchParams: () => new URLSearchParams(),
}));

// Mock the API hooks
vi.mock("@/lib/api/transactions", () => ({
  useTransactions: vi.fn(),
}));

// Mock toast hook
vi.mock("@/hooks/use-toast", () => ({
  useToast: () => ({
    toast: vi.fn(),
  }),
}));

describe("3.5-COMPONENT: TransactionList Component", () => {
  const mockTransactions: Transaction[] = [
    {
      transaction_id: "123e4567-e89b-12d3-a456-426614174000",
      public_id: "TXN-001",
      store_id: "223e4567-e89b-12d3-a456-426614174001",
      shift_id: "323e4567-e89b-12d3-a456-426614174002",
      cashier_id: "423e4567-e89b-12d3-a456-426614174003",
      timestamp: new Date("2024-01-01T10:00:00Z"),
      total: 100.0,
      subtotal: 92.59,
      tax: 7.41,
      discount: 0,
    },
    {
      transaction_id: "523e4567-e89b-12d3-a456-426614174004",
      public_id: "TXN-002",
      store_id: "223e4567-e89b-12d3-a456-426614174001",
      shift_id: "323e4567-e89b-12d3-a456-426614174002",
      cashier_id: "423e4567-e89b-12d3-a456-426614174003",
      timestamp: new Date("2024-01-01T11:00:00Z"),
      total: 200.0,
      subtotal: 185.19,
      tax: 14.81,
      discount: 0,
    },
  ];

  const mockResponse: TransactionQueryResult = {
    transactions: mockTransactions,
    meta: {
      total: 2,
      limit: 50,
      offset: 0,
      has_more: false,
    },
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("[P0] 3.5-COMPONENT-001: should render loading skeleton when data is loading", () => {
    // GIVEN: Transactions API is loading
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: undefined,
      isLoading: true,
      error: null,
      isError: false,
      isSuccess: false,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(<TransactionList />);

    // THEN: Loading skeleton should be displayed
    const skeletonLoaders = document.querySelectorAll(".animate-pulse");
    expect(skeletonLoaders.length).toBeGreaterThan(0);
  });

  it("[P0] 3.5-COMPONENT-002: should render error message when API fails", () => {
    // GIVEN: Transactions API returns an error
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: undefined,
      isLoading: false,
      error: new Error("Failed to load transactions"),
      isError: true,
      isSuccess: false,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(<TransactionList />);

    // THEN: Error message should be displayed
    expect(
      screen.getByText(/error loading transactions/i),
    ).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-003: should render empty state when no transactions exist", () => {
    // GIVEN: Transactions API returns empty list
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: { transactions: [], meta: mockResponse.meta },
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(<TransactionList />);

    // THEN: Empty state should be displayed
    expect(
      screen.getByText(/no transactions found/i),
    ).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-004: should render transaction list with required columns", () => {
    // GIVEN: Transactions API returns data
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: mockResponse,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(<TransactionList />);

    // THEN: Transaction table should display required columns
    expect(screen.getByText("Transaction ID")).toBeInTheDocument();
    expect(screen.getByText("Timestamp")).toBeInTheDocument();
    expect(screen.getByText("Total")).toBeInTheDocument();
    expect(screen.getByText("Cashier")).toBeInTheDocument();
    expect(screen.getByText("Store")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-005: should display transaction data in table rows", () => {
    // GIVEN: Transactions API returns data
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: mockResponse,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(<TransactionList />);

    // THEN: Transaction data should be displayed
    expect(screen.getByText("TXN-001")).toBeInTheDocument();
    expect(screen.getByText("TXN-002")).toBeInTheDocument();
    expect(screen.getByText("$100.00")).toBeInTheDocument();
    expect(screen.getByText("$200.00")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-006: should call onTransactionClick when transaction row is clicked", async () => {
    // GIVEN: Transactions API returns data and onTransactionClick handler
    const onTransactionClick = vi.fn();
    vi.mocked(transactionsApi.useTransactions).mockReturnValue({
      data: mockResponse,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered and transaction row is clicked
    renderWithProviders(
      <TransactionList onTransactionClick={onTransactionClick} />,
    );

    const transactionRow = screen.getByTestId(
      `transaction-row-${mockTransactions[0].transaction_id}`,
    );
    transactionRow.click();

    // THEN: onTransactionClick should be called with transaction data
    await waitFor(() => {
      expect(onTransactionClick).toHaveBeenCalledWith(mockTransactions[0]);
    });
  });
});

