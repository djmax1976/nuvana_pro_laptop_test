/**
 * Activate Pack Modal Component Tests
 *
 * Tests for ActivatePackModal component:
 * - Two-step modal flow (Step 1: Auth, Step 2: Scan & Select)
 * - Cashier authentication with PIN verification
 * - Pack scanning and validation
 * - Bin selection with warning for active packs
 * - Pack activation flow
 *
 * @test-level Component
 * @justification Tests UI component behavior, form interactions, and validation feedback
 * @story 10-6 - Activate Pack During Shift
 * @priority P0-P1 (Mixed - Core UI functionality)
 *
 * RED PHASE: These tests will fail until ActivatePackModal component is implemented.
 */

import { describe, it, expect, vi, beforeEach, afterEach } from "vitest";
import { renderWithProviders, screen, waitFor } from "../../support/test-utils";
import userEvent from "@testing-library/user-event";
import { createBinWithPack, createBinsWithPacks } from "../../support/factories/shift-closing.factory";

// Mock global fetch for API calls
const mockFetch = vi.fn();
global.fetch = mockFetch;

describe("10-6-COMPONENT: ActivatePackModal", () => {
  const mockOnOpenChange = vi.fn();
  const mockOnPackActivated = vi.fn();
  const defaultProps = {
    open: true,
    onOpenChange: mockOnOpenChange,
    storeId: "store-123",
    currentShiftId: "shift-123",
    bins: createBinsWithPacks(3),
    onPackActivated: mockOnPackActivated,
  };

  beforeEach(() => {
    vi.clearAllMocks();
    
    // Default mock responses
    // Mock cashiers query
    mockFetch.mockImplementation((url: string) => {
      if (url.includes("/api/stores/store-123/cashiers") && url.includes("shiftId=shift-123")) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            success: true,
            data: [
              { cashier_id: "cashier-1", name: "Cashier 1", employee_id: "emp-1" },
              { cashier_id: "cashier-2", name: "Cashier 2", employee_id: "emp-2" },
            ],
          }),
        } as Response);
      }
      
      // Mock PIN verification - valid PIN "1234"
      if (url.includes("/api/auth/verify-cashier-permission")) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            valid: true,
            userId: "cashier-1",
            name: "Cashier 1",
            hasPermission: true,
          }),
        } as Response);
      }
      
      // Mock pack validation - valid pack
      if (url.includes("/api/lottery/packs/validate-for-activation")) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            valid: true,
            game: { name: "$5 Powerball", price: 5 },
            pack: {
              pack_id: "pack-123",
              serial_start: "001",
              serial_end: "100",
              pack_number: "1234567",
            },
          }),
        } as Response);
      }
      
      // Mock pack activation
      if (url.includes("/api/stores/store-123/lottery/packs/activate")) {
        return Promise.resolve({
          ok: true,
          json: () => Promise.resolve({
            success: true,
            data: {
              updatedBin: createBinWithPack({
                bin_id: "bin-1",
                bin_number: 1,
                pack: {
                  pack_id: "pack-123",
                  game_name: "$5 Powerball",
                  game_price: 5,
                  starting_serial: "001",
                  serial_end: "100",
                  pack_number: "1234567",
                },
              }),
            },
          }),
        } as Response);
      }
      
      // Default response
      return Promise.resolve({
        ok: true,
        json: () => Promise.resolve({ success: true, data: {} }),
      } as Response);
    });
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-1: Activate Pack Button (P3)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-001: [P3] should render Activate Pack button in ShiftClosingActions", async () => {
    // GIVEN: ShiftClosingActions component
    // WHEN: Component is rendered
    // Note: This test verifies the button exists in parent component
    // Component doesn't exist yet, test will fail (RED phase)
    const { ShiftClosingActions } = await import(
      "@/components/shift-closing/ShiftClosingActions"
    );
    const { renderWithProviders, screen } = await import(
      "../../support/test-utils"
    );

    renderWithProviders(
      <ShiftClosingActions
        canProceed={false}
        onAddBin={vi.fn()}
        onActivatePack={vi.fn()}
        onManualEntry={vi.fn()}
        onNext={vi.fn()}
      />,
    );

    // THEN: Activate Pack button is visible
    expect(screen.getByTestId("activate-pack-button")).toBeInTheDocument();
    expect(screen.getByText("Activate Pack")).toBeInTheDocument();
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-2: Step 1 - Cashier Authentication (P1)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-002: [P1] should show Step 1 (auth) initially", async () => {
    // GIVEN: ActivatePackModal is opened
    // WHEN: Modal is rendered
    // Component doesn't exist yet, test will fail (RED phase)
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // THEN: Step 1 (Cashier Authentication) is displayed
    expect(screen.getByTestId("step-1-auth")).toBeInTheDocument();
    expect(screen.getByText("Step 1: Cashier Authentication")).toBeInTheDocument();
    expect(screen.getByTestId("cashier-dropdown")).toBeInTheDocument();
    expect(screen.getByTestId("pin-input")).toBeInTheDocument();
  });

  it("10-6-COMPONENT-003: [P1] should show only active shift cashiers in dropdown", async () => {
    // GIVEN: ActivatePackModal with storeId and currentShiftId
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: Opening cashier dropdown
    const dropdown = screen.getByTestId("cashier-dropdown");
    await user.click(dropdown);

    // THEN: Only cashiers with active shifts at this store are shown
    await waitFor(() => {
      expect(screen.getByText("Cashier 1")).toBeInTheDocument();
      expect(screen.queryByText("Inactive Cashier")).not.toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-004: [P1] should mask PIN input field", async () => {
    // GIVEN: ActivatePackModal component
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User types PIN
    const pinInput = screen.getByTestId("pin-input");
    await user.type(pinInput, "1234");

    // THEN: PIN is masked (password type)
    expect(pinInput).toHaveAttribute("type", "password");
  });

  it("10-6-COMPONENT-005: [P1] should show Cancel and Verify buttons", async () => {
    // GIVEN: ActivatePackModal component
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // THEN: Cancel and Verify buttons are visible
    expect(screen.getByTestId("cancel-button")).toBeInTheDocument();
    expect(screen.getByTestId("verify-button")).toBeInTheDocument();
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-3: PIN Verification (P1)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-006: [P1] should validate PIN before proceeding", async () => {
    // GIVEN: ActivatePackModal with cashier selected and PIN entered
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User enters invalid PIN and clicks Verify
    const dropdown = screen.getByTestId("cashier-dropdown");
    await user.click(dropdown);
    await user.click(screen.getByText("Cashier 1"));

    const pinInput = screen.getByTestId("pin-input");
    await user.type(pinInput, "9999"); // Invalid PIN

    const verifyButton = screen.getByTestId("verify-button");
    await user.click(verifyButton);

    // THEN: Error message is displayed and stays on Step 1
    await waitFor(() => {
      expect(screen.getByTestId("error-message")).toBeInTheDocument();
      expect(screen.getByText("Invalid PIN")).toBeInTheDocument();
      expect(screen.getByTestId("step-1-auth")).toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-007: [P1] should proceed to Step 2 after successful PIN verification", async () => {
    // GIVEN: ActivatePackModal with cashier selected and valid PIN
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User enters valid PIN and clicks Verify
    const dropdown = screen.getByTestId("cashier-dropdown");
    await user.click(dropdown);
    await user.click(screen.getByText("Cashier 1"));

    const pinInput = screen.getByTestId("pin-input");
    await user.type(pinInput, "1234"); // Valid PIN

    const verifyButton = screen.getByTestId("verify-button");
    await user.click(verifyButton);

    // THEN: Step 2 is displayed
    await waitFor(() => {
      expect(screen.getByTestId("step-2-scan")).toBeInTheDocument();
      expect(screen.queryByTestId("step-1-auth")).not.toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-008: [P1] should display verified cashier name in Step 2", async () => {
    // GIVEN: ActivatePackModal after successful PIN verification
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User completes Step 1 authentication
    const dropdown = screen.getByTestId("cashier-dropdown");
    await user.click(dropdown);
    await user.click(screen.getByText("Cashier 1"));

    const pinInput = screen.getByTestId("pin-input");
    await user.type(pinInput, "1234");

    const verifyButton = screen.getByTestId("verify-button");
    await user.click(verifyButton);

    // THEN: Verified cashier name is displayed in Step 2
    await waitFor(() => {
      expect(screen.getByTestId("verified-cashier-name")).toBeInTheDocument();
      expect(screen.getByText("Cashier 1")).toBeInTheDocument();
    });
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-4: Step 2 - Scan Pack (P2)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-009: [P2] should show 24-digit serial input field in Step 2", async () => {
    // GIVEN: ActivatePackModal in Step 2
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User completes Step 1 and reaches Step 2
    // (Mock successful auth for this test)
    // THEN: 24-digit serial input field is visible
    await waitFor(() => {
      expect(screen.getByTestId("serial-input")).toBeInTheDocument();
      expect(screen.getByTestId("serial-input")).toHaveAttribute("maxLength", "24");
    });
  });

  it("10-6-COMPONENT-010: [P2] should show bin dropdown with all bins in Step 2", async () => {
    // GIVEN: ActivatePackModal in Step 2 with bins
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: Step 2 is displayed
    // THEN: Bin dropdown shows all bins with current pack info
    await waitFor(() => {
      const binDropdown = screen.getByTestId("bin-dropdown");
      expect(binDropdown).toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-011: [P2] should display bin info (pack or Empty) in dropdown", async () => {
    // GIVEN: ActivatePackModal with bins (some with packs, some empty)
    const bins = [
      createBinWithPack({ bin_number: 1, pack: { pack_id: "pack-1", game_name: "$5 Powerball", game_price: 5, starting_serial: "001", serial_end: "100", pack_number: "1234567" } }),
      createBinWithPack({ bin_number: 2, pack: null }),
    ];
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} bins={bins} />);

    // WHEN: Opening bin dropdown
    const binDropdown = screen.getByTestId("bin-dropdown");
    await user.click(binDropdown);

    // THEN: Bins show pack info or "Empty"
    await waitFor(() => {
      expect(screen.getByText(/Bin 1.*\$5 Powerball/)).toBeInTheDocument();
      expect(screen.getByText(/Bin 2.*Empty/)).toBeInTheDocument();
    });
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-5: Pack Validation (P0)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-012: [P0] should accept 24-digit barcode scan", async () => {
    // GIVEN: ActivatePackModal in Step 2
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User scans 24-digit barcode
    const serialInput = screen.getByTestId("serial-input");
    await user.type(serialInput, "000112345670123456789012");

    // THEN: Serial is accepted (no error)
    expect(serialInput).toHaveValue("000112345670123456789012");
  });

  it("10-6-COMPONENT-013: [P0] should show pack info after valid scan", async () => {
    // GIVEN: ActivatePackModal in Step 2
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User scans valid 24-digit pack barcode
    const serialInput = screen.getByTestId("serial-input");
    await user.type(serialInput, "000112345670123456789012");

    // THEN: Pack info is displayed (game name, price, pack number, Available status)
    await waitFor(() => {
      expect(screen.getByTestId("pack-info")).toBeInTheDocument();
      expect(screen.getByText(/Available/)).toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-014: [P0] should show error for invalid pack", async () => {
    // GIVEN: ActivatePackModal in Step 2
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User scans invalid pack (wrong game code or unavailable pack)
    const serialInput = screen.getByTestId("serial-input");
    await user.type(serialInput, "999912345670123456789012"); // Invalid game code

    // THEN: Error message is displayed
    await waitFor(() => {
      expect(screen.getByTestId("scan-error")).toBeInTheDocument();
      expect(screen.getByText(/Unknown game code|Pack not available/)).toBeInTheDocument();
    });
  });

  it("10-6-COMPONENT-015: [P0] should show error for pack with status ACTIVE", async () => {
    // GIVEN: ActivatePackModal in Step 2
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User scans pack that is already ACTIVE in another bin
    const serialInput = screen.getByTestId("serial-input");
    await user.type(serialInput, "000112345670123456789012"); // Pack already active

    // THEN: Error message indicates pack is already active
    await waitFor(() => {
      expect(screen.getByTestId("scan-error")).toBeInTheDocument();
      expect(screen.getByText(/already active/)).toBeInTheDocument();
    });
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-6: Bin Selection (P1)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-016: [P1] should show no warning when selecting empty bin", async () => {
    // GIVEN: ActivatePackModal with pack validated and empty bin available
    const bins = [
      createBinWithPack({ bin_number: 1, pack: null }),
    ];
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} bins={bins} />);

    // WHEN: User selects empty bin
    const binDropdown = screen.getByTestId("bin-dropdown");
    await user.click(binDropdown);
    await user.click(screen.getByText(/Bin 1.*Empty/));

    // THEN: No warning is displayed
    expect(screen.queryByTestId("bin-warning")).not.toBeInTheDocument();
  });

  it("10-6-COMPONENT-017: [P1] should show warning when selecting bin with active pack", async () => {
    // GIVEN: ActivatePackModal with pack validated and bin with active pack
    const bins = [
      createBinWithPack({ 
        bin_number: 1, 
        pack: { 
          pack_id: "pack-1", 
          game_name: "$5 Powerball", 
          game_price: 5, 
          starting_serial: "001", 
          serial_end: "100", 
          pack_number: "1234567" 
        } 
      }),
    ];
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} bins={bins} />);

    // WHEN: User selects bin with active pack
    const binDropdown = screen.getByTestId("bin-dropdown");
    await user.click(binDropdown);
    await user.click(screen.getByText(/Bin 1.*\$5 Powerball/));

    // THEN: Warning is displayed
    await waitFor(() => {
      expect(screen.getByTestId("bin-warning")).toBeInTheDocument();
      expect(screen.getByText(/This bin already has.*Activating will replace it/)).toBeInTheDocument();
    });
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AC-7: Activate Pack (P0)
  // ═══════════════════════════════════════════════════════════════════════════

  it("10-6-COMPONENT-018: [P0] should call onPackActivated after successful activation", async () => {
    // GIVEN: ActivatePackModal with pack validated and bin selected
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User clicks Activate button
    const activateButton = screen.getByTestId("activate-button");
    await user.click(activateButton);

    // THEN: onPackActivated callback is called with updated bin
    await waitFor(() => {
      expect(mockOnPackActivated).toHaveBeenCalledTimes(1);
      expect(mockOnPackActivated).toHaveBeenCalledWith(
        expect.objectContaining({
          bin_id: expect.any(String),
          pack: expect.objectContaining({
            pack_id: expect.any(String),
          }),
        }),
        undefined, // No previous pack
      );
    });
  });

  it("10-6-COMPONENT-019: [P0] should close modal after successful activation", async () => {
    // GIVEN: ActivatePackModal with pack validated and bin selected
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} />);

    // WHEN: User clicks Activate button
    const activateButton = screen.getByTestId("activate-button");
    await user.click(activateButton);

    // THEN: Modal closes (onOpenChange called with false)
    await waitFor(() => {
      expect(mockOnOpenChange).toHaveBeenCalledWith(false);
    });
  });

  it("10-6-COMPONENT-020: [P0] should pass previous pack info when replacing active pack", async () => {
    // GIVEN: ActivatePackModal with bin that has active pack
    const bins = [
      createBinWithPack({ 
        bin_number: 1, 
        pack: { 
          pack_id: "previous-pack-1", 
          game_name: "$5 Powerball", 
          game_price: 5, 
          starting_serial: "001", 
          serial_end: "100", 
          pack_number: "1234567" 
        } 
      }),
    ];
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    renderWithProviders(<ActivatePackModal {...defaultProps} bins={bins} />);

    // WHEN: User activates new pack in bin with existing pack
    const activateButton = screen.getByTestId("activate-button");
    await user.click(activateButton);

    // THEN: onPackActivated is called with previous pack info
    await waitFor(() => {
      expect(mockOnPackActivated).toHaveBeenCalledWith(
        expect.objectContaining({
          bin_id: expect.any(String),
        }),
        expect.objectContaining({
          pack_id: "previous-pack-1",
        }),
      );
    });
  });

  it("10-6-COMPONENT-021: [P1] should reset state when modal closes", async () => {
    // GIVEN: ActivatePackModal that was opened and used
    const { ActivatePackModal } = await import(
      "@/components/shift-closing/ActivatePackModal"
    );
    const user = userEvent.setup();

    const { rerender } = renderWithProviders(
      <ActivatePackModal {...defaultProps} open={true} />,
    );

    // WHEN: Modal is closed and reopened
    await user.click(screen.getByTestId("cancel-button"));
    rerender(<ActivatePackModal {...defaultProps} open={true} />);

    // THEN: State is reset (Step 1 is shown again)
    await waitFor(() => {
      expect(screen.getByTestId("step-1-auth")).toBeInTheDocument();
      expect(screen.queryByTestId("step-2-scan")).not.toBeInTheDocument();
    });
  });
});
