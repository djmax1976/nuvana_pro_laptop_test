/**
 * Manual Entry Mode Component Tests
 *
 * Tests for manual entry mode functionality:
 * - Manual Entry button visibility
 * - Manual entry mode activation
 * - Visual indicator display
 * - Direct 3-digit typing in manual mode
 * - Validation in manual mode (range checks only)
 * - Pack number validation skipped
 * - Mode persistence (resets on navigation)
 *
 * @test-level Component
 * @justification Tests UI component behavior and state management
 * @story 10-4 - Manual Entry Override
 * @priority P1 (High - Core Feature)
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { renderWithProviders, screen, waitFor } from "../../support/test-utils";
import userEvent from "@testing-library/user-event";

describe("10-4-COMPONENT: Manual Entry Mode", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("10-4-COMPONENT-009: should show Manual Entry button on Lottery Shift Closing page", async () => {
    // GIVEN: LotteryShiftClosingPage component
    // WHEN: Page is rendered
    // Note: Component doesn't exist yet, test will fail (RED phase)
    const { LotteryShiftClosingPage } = await import(
      "@/components/shift-closing/LotteryShiftClosingPage"
    );

    renderWithProviders(<LotteryShiftClosingPage />);

    // THEN: Manual Entry button is visible
    const manualEntryButton = screen.getByTestId("manual-entry-button");
    expect(manualEntryButton).toBeInTheDocument();
    expect(manualEntryButton).toHaveTextContent("Manual Entry");
  });

  it("10-4-COMPONENT-010: should open auth modal when Manual Entry button clicked", async () => {
    // GIVEN: LotteryShiftClosingPage component
    const { LotteryShiftClosingPage } = await import(
      "@/components/shift-closing/LotteryShiftClosingPage"
    );
    const user = userEvent.setup();

    renderWithProviders(<LotteryShiftClosingPage />);

    // WHEN: User clicks Manual Entry button
    const manualEntryButton = screen.getByTestId("manual-entry-button");
    await user.click(manualEntryButton);

    // THEN: Auth modal opens
    await waitFor(() => {
      expect(screen.getByTestId("manual-entry-auth-modal")).toBeInTheDocument();
    });
  });

  it("10-4-COMPONENT-011: should show Manual Entry Mode Active indicator after authorization", async () => {
    // GIVEN: LotteryShiftClosingPage component with authorized manual entry
    const { LotteryShiftClosingPage } = await import(
      "@/components/shift-closing/LotteryShiftClosingPage"
    );
    const user = userEvent.setup();

    renderWithProviders(<LotteryShiftClosingPage />);

    // WHEN: User authorizes manual entry
    const manualEntryButton = screen.getByTestId("manual-entry-button");
    await user.click(manualEntryButton);

    // Simulate successful authorization
    // (In real test, would interact with modal)
    // For now, assume authorization callback is triggered

    // THEN: Visual indicator shows "Manual Entry Mode Active"
    await waitFor(() => {
      const indicator = screen.getByTestId("manual-entry-indicator");
      expect(indicator).toBeInTheDocument();
      expect(indicator).toHaveTextContent(/manual entry mode active/i);
    });
  });

  it("10-4-COMPONENT-012: should allow direct 3-digit typing in manual mode", async () => {
    // GIVEN: EndingNumberInput component with manualEntryMode=true
    const { EndingNumberInput } = await import(
      "@/components/shift-closing/EndingNumberInput"
    );
    const user = userEvent.setup();
    const mockOnChange = vi.fn();

    renderWithProviders(
      <EndingNumberInput
        value=""
        onChange={mockOnChange}
        binId="bin-1"
        packNumber="123456"
        startingSerial="045"
        serialEnd="150"
        manualEntryMode={true}
      />,
    );

    // WHEN: User types 3-digit number directly
    const input = screen.getByTestId("ending-number-input-bin-1");
    await user.type(input, "100");

    // THEN: Input accepts the value
    expect(mockOnChange).toHaveBeenCalledWith("100");
    expect(input).toHaveValue("100");
  });

  it("10-4-COMPONENT-013: should still validate range in manual mode", async () => {
    // GIVEN: EndingNumberInput component with manualEntryMode=true
    const { EndingNumberInput } = await import(
      "@/components/shift-closing/EndingNumberInput"
    );
    const user = userEvent.setup();
    const mockOnChange = vi.fn();

    renderWithProviders(
      <EndingNumberInput
        value=""
        onChange={mockOnChange}
        binId="bin-1"
        packNumber="123456"
        startingSerial="045"
        serialEnd="150"
        manualEntryMode={true}
      />,
    );

    // WHEN: User enters ending number less than starting
    const input = screen.getByTestId("ending-number-input-bin-1");
    await user.type(input, "040");
    await user.blur(input);

    // THEN: Validation error is displayed
    await waitFor(() => {
      expect(screen.getByTestId("ending-number-error-bin-1")).toBeInTheDocument();
      expect(
        screen.getByText(/ending number cannot be less than starting/i),
      ).toBeInTheDocument();
    });
  });

  it("10-4-COMPONENT-014: should skip pack number validation in manual mode", async () => {
    // GIVEN: EndingNumberInput component with manualEntryMode=true
    // AND: Wrong pack number (would fail in scan mode)
    const { EndingNumberInput } = await import(
      "@/components/shift-closing/EndingNumberInput"
    );
    const user = userEvent.setup();
    const mockOnChange = vi.fn();

    renderWithProviders(
      <EndingNumberInput
        value=""
        onChange={mockOnChange}
        binId="bin-1"
        packNumber="123456" // Expected pack
        startingSerial="045"
        serialEnd="150"
        manualEntryMode={true}
      />,
    );

    // WHEN: User enters valid ending number (pack validation skipped)
    const input = screen.getByTestId("ending-number-input-bin-1");
    await user.type(input, "100");
    await user.blur(input);

    // THEN: No pack validation error (validation skipped)
    await waitFor(() => {
      expect(
        screen.queryByText(/wrong pack/i),
      ).not.toBeInTheDocument();
    });
  });

  it("10-4-COMPONENT-015: should reset manual entry mode on page navigation", async () => {
    // GIVEN: LotteryShiftClosingPage with active manual entry mode
    const { LotteryShiftClosingPage } = await import(
      "@/components/shift-closing/LotteryShiftClosingPage"
    );

    const { rerender } = renderWithProviders(<LotteryShiftClosingPage />);

    // Simulate manual entry mode active
    // (In real test, would set state)

    // WHEN: Component unmounts (navigation away)
    rerender(<div />);

    // THEN: Manual entry mode is reset
    // (When component remounts, mode should be inactive)
    rerender(<LotteryShiftClosingPage />);

    await waitFor(() => {
      expect(
        screen.queryByTestId("manual-entry-indicator"),
      ).not.toBeInTheDocument();
    });
  });

  it("10-4-COMPONENT-016: should keep barcode scanning functional in manual mode", async () => {
    // GIVEN: EndingNumberInput component with manualEntryMode=true
    const { EndingNumberInput } = await import(
      "@/components/shift-closing/EndingNumberInput"
    );
    const mockOnChange = vi.fn();

    renderWithProviders(
      <EndingNumberInput
        value=""
        onChange={mockOnChange}
        binId="bin-1"
        packNumber="123456"
        startingSerial="045"
        serialEnd="150"
        manualEntryMode={true}
      />,
    );

    // WHEN: 24-digit barcode is scanned
    const input = screen.getByTestId("ending-number-input-bin-1");
    
    // Simulate barcode scan (24 digits)
    const barcodeEvent = new Event("input", { bubbles: true });
    Object.defineProperty(barcodeEvent, "target", {
      value: { value: "000112345670123456789012" },
    });
    input.dispatchEvent(barcodeEvent);

    // THEN: Barcode scanning still works (both modes available)
    // Note: This would trigger the barcode scanning handler
    // The test verifies that manual mode doesn't disable scanning
    expect(input).toBeInTheDocument();
  });
});
