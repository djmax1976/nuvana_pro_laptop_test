/**
 * @test-level Component
 * @justification Component tests for TransactionFilters - validates filter controls and state management
 * @story 3-5-transaction-display-ui
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { renderWithProviders, screen, waitFor } from "../support/test-utils";
import { TransactionFilters } from "@/components/transactions/TransactionFilters";
import userEvent from "@testing-library/user-event";

// Mock date-fns
vi.mock("date-fns", () => ({
  format: vi.fn((date: Date) => date.toISOString().split("T")[0]),
  parse: vi.fn((dateString: string) => new Date(dateString)),
}));

describe("3.5-COMPONENT: TransactionFilters Component", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("[P0] 3.5-COMPONENT-010: should render date range picker filter", () => {
    // GIVEN: Component is rendered
    const onFiltersChange = vi.fn();
    renderWithProviders(
      <TransactionFilters onFiltersChange={onFiltersChange} />,
    );

    // THEN: Date range picker should be displayed
    expect(
      screen.getByTestId("date-range-picker-from"),
    ).toBeInTheDocument();
    expect(screen.getByTestId("date-range-picker-to")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-011: should render shift filter dropdown", () => {
    // GIVEN: Component is rendered
    const onFiltersChange = vi.fn();
    renderWithProviders(
      <TransactionFilters onFiltersChange={onFiltersChange} />,
    );

    // THEN: Shift filter dropdown should be displayed
    expect(screen.getByTestId("shift-filter-select")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-012: should render cashier filter dropdown", () => {
    // GIVEN: Component is rendered
    const onFiltersChange = vi.fn();
    renderWithProviders(
      <TransactionFilters onFiltersChange={onFiltersChange} />,
    );

    // THEN: Cashier filter dropdown should be displayed
    expect(screen.getByTestId("cashier-filter-select")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-013: should call onFiltersChange when date range is updated and applied", async () => {
    // GIVEN: Component is rendered
    const onFiltersChange = vi.fn();
    const user = userEvent.setup();
    renderWithProviders(
      <TransactionFilters onFiltersChange={onFiltersChange} />,
    );

    // WHEN: Date range is updated and Apply Filters is clicked
    const fromInput = screen.getByTestId("date-range-picker-from");
    const toInput = screen.getByTestId("date-range-picker-to");

    await user.type(fromInput, "2024-01-01");
    await user.type(toInput, "2024-01-31");
    
    const applyButton = screen.getByTestId("apply-filters-button");
    await user.click(applyButton);

    // THEN: onFiltersChange should be called with updated filters
    await waitFor(() => {
      expect(onFiltersChange).toHaveBeenCalled();
    });
  });

  it("[P0] 3.5-COMPONENT-014: should call onFiltersChange when shift filter is selected and applied", async () => {
    // GIVEN: Component is rendered with shift options
    const onFiltersChange = vi.fn();
    const shifts = [
      { shift_id: "shift-1", name: "Morning Shift" },
      { shift_id: "shift-2", name: "Evening Shift" },
    ];
    const user = userEvent.setup();
    renderWithProviders(
      <TransactionFilters
        onFiltersChange={onFiltersChange}
        shifts={shifts}
      />,
    );

    // WHEN: Shift filter is selected and Apply Filters is clicked
    const shiftSelect = screen.getByTestId("shift-filter-select");
    await user.click(shiftSelect);
    const shiftOption = screen.getByTestId("shift-option-shift-1");
    await user.click(shiftOption);
    
    const applyButton = screen.getByTestId("apply-filters-button");
    await user.click(applyButton);

    // THEN: onFiltersChange should be called with selected shift
    await waitFor(() => {
      expect(onFiltersChange).toHaveBeenCalledWith(
        expect.objectContaining({ shift_id: "shift-1" }),
      );
    });
  });

  it("[P0] 3.5-COMPONENT-015: should call onFiltersChange when cashier filter is selected and applied", async () => {
    // GIVEN: Component is rendered with cashier options
    const onFiltersChange = vi.fn();
    const cashiers = [
      { cashier_id: "cashier-1", name: "John Cashier" },
      { cashier_id: "cashier-2", name: "Jane Cashier" },
    ];
    const user = userEvent.setup();
    renderWithProviders(
      <TransactionFilters
        onFiltersChange={onFiltersChange}
        cashiers={cashiers}
      />,
    );

    // WHEN: Cashier filter is selected and Apply Filters is clicked
    const cashierSelect = screen.getByTestId("cashier-filter-select");
    await user.click(cashierSelect);
    const cashierOption = screen.getByTestId("cashier-option-cashier-1");
    await user.click(cashierOption);
    
    const applyButton = screen.getByTestId("apply-filters-button");
    await user.click(applyButton);

    // THEN: onFiltersChange should be called with selected cashier
    await waitFor(() => {
      expect(onFiltersChange).toHaveBeenCalledWith(
        expect.objectContaining({ cashier_id: "cashier-1" }),
      );
    });
  });

  it("[P0] 3.5-COMPONENT-016: should display clear filters button when filters are active", () => {
    // GIVEN: Component is rendered with active filters
    const onFiltersChange = vi.fn();
    renderWithProviders(
      <TransactionFilters
        onFiltersChange={onFiltersChange}
        filters={{ from: "2024-01-01T00:00:00Z" }}
      />,
    );

    // THEN: Clear filters button should be displayed
    expect(screen.getByTestId("clear-filters-button")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-017: should clear all filters when clear button is clicked", async () => {
    // GIVEN: Component is rendered with filters applied
    const onFiltersChange = vi.fn();
    const user = userEvent.setup();
    renderWithProviders(
      <TransactionFilters
        onFiltersChange={onFiltersChange}
        filters={{ from: "2024-01-01T00:00:00Z", shift_id: "shift-1" }}
      />,
    );

    // WHEN: Clear filters button is clicked
    const clearButton = screen.getByTestId("clear-filters-button");
    await user.click(clearButton);

    // THEN: onFiltersChange should be called with empty filters
    await waitFor(() => {
      expect(onFiltersChange).toHaveBeenCalledWith({});
    });
  });
});

