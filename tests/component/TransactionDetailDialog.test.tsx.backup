/**
 * @test-level Component
 * @justification Component tests for TransactionDetailDialog - validates dialog display, line items, and payments
 * @story 3-5-transaction-display-ui
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { renderWithProviders, screen, waitFor } from "../support/test-utils";
import { TransactionDetailDialog } from "@/components/transactions/TransactionDetailDialog";
import * as transactionsApi from "@/lib/api/transactions";
import type { Transaction } from "@/lib/api/transactions";

// Mock Next.js navigation
vi.mock("next/navigation", () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    back: vi.fn(),
    forward: vi.fn(),
    refresh: vi.fn(),
    prefetch: vi.fn(),
  }),
  usePathname: () => "/",
  useSearchParams: () => new URLSearchParams(),
}));

// Mock the API hooks
vi.mock("@/lib/api/transactions", () => ({
  useTransactionDetail: vi.fn(),
}));

// Mock toast hook
vi.mock("@/hooks/use-toast", () => ({
  useToast: () => ({
    toast: vi.fn(),
  }),
}));

describe("3.5-COMPONENT: TransactionDetailDialog Component", () => {
  const mockTransaction: Transaction = {
    transaction_id: "123e4567-e89b-12d3-a456-426614174000",
    public_id: "TXN-001",
    store_id: "223e4567-e89b-12d3-a456-426614174001",
    shift_id: "323e4567-e89b-12d3-a456-426614174002",
    cashier_id: "423e4567-e89b-12d3-a456-426614174003",
    timestamp: new Date("2024-01-01T10:00:00Z"),
    total: 100.0,
    subtotal: 92.59,
    tax: 7.41,
    discount: 0,
    line_items: [
      {
        line_item_id: "line-1",
        transaction_id: "123e4567-e89b-12d3-a456-426614174000",
        product_id: null,
        sku: "SKU-001",
        name: "Test Product",
        quantity: 2,
        unit_price: 50.0,
        discount: 0,
        line_total: 100.0,
      },
    ],
    payments: [
      {
        payment_id: "payment-1",
        transaction_id: "123e4567-e89b-12d3-a456-426614174000",
        method: "CASH",
        amount: 100.0,
        reference: null,
      },
    ],
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it("[P0] 3.5-COMPONENT-020: should render dialog when open is true", () => {
    // GIVEN: Component is rendered with open=true
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: mockTransaction,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Dialog should be visible
    expect(
      screen.getByTestId("transaction-detail-dialog"),
    ).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-021: should not render dialog when open is false", () => {
    // GIVEN: Component is rendered with open=false
    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={false}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Dialog should not be visible
    expect(
      screen.queryByTestId("transaction-detail-dialog"),
    ).not.toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-022: should display transaction header information", () => {
    // GIVEN: Component is rendered with transaction data
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: mockTransaction,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Transaction header should display transaction ID
    expect(screen.getByText("TXN-001")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-023: should display line items table", () => {
    // GIVEN: Component is rendered with transaction data including line items
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: mockTransaction,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Line items table should be displayed
    expect(screen.getByTestId("line-items-table")).toBeInTheDocument();
    expect(screen.getByText("Test Product")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-024: should display payments table", () => {
    // GIVEN: Component is rendered with transaction data including payments
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: mockTransaction,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Payments table should be displayed
    expect(screen.getByTestId("payments-table")).toBeInTheDocument();
    expect(screen.getByText("CASH")).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-025: should display loading state while fetching transaction detail", () => {
    // GIVEN: Transaction detail API is loading
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: undefined,
      isLoading: true,
      error: null,
      isError: false,
      isSuccess: false,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Loading state should be displayed
    const skeletonLoaders = document.querySelectorAll(".animate-pulse");
    expect(skeletonLoaders.length).toBeGreaterThan(0);
  });

  it("[P0] 3.5-COMPONENT-026: should display error message when transaction detail API fails", () => {
    // GIVEN: Transaction detail API returns an error
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: undefined,
      isLoading: false,
      error: new Error("Failed to load transaction detail"),
      isError: true,
      isSuccess: false,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={vi.fn()}
      />,
    );

    // THEN: Error message should be displayed
    expect(
      screen.getByText(/failed to load transaction detail/i),
    ).toBeInTheDocument();
  });

  it("[P0] 3.5-COMPONENT-027: should call onOpenChange when close button is clicked", async () => {
    // GIVEN: Component is rendered with onOpenChange handler
    const onOpenChange = vi.fn();
    vi.mocked(transactionsApi.useTransactionDetail).mockReturnValue({
      data: mockTransaction,
      isLoading: false,
      error: null,
      isError: false,
      isSuccess: true,
      refetch: vi.fn(),
    } as any);

    // WHEN: Component is rendered and close button is clicked
    renderWithProviders(
      <TransactionDetailDialog
        transactionId={mockTransaction.transaction_id}
        open={true}
        onOpenChange={onOpenChange}
      />,
    );

    const closeButton = screen.getByRole("button", { name: /close/i });
    closeButton.click();

    // THEN: onOpenChange should be called with false
    await waitFor(() => {
      expect(onOpenChange).toHaveBeenCalledWith(false);
    });
  });
});

