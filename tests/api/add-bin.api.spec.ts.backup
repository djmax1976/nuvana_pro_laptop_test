/**
 * Add Bin API Tests
 *
 * Tests for Add Bin API endpoints:
 * - GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber
 * - POST /api/stores/:storeId/lottery/bins/create-with-pack
 * - Authentication and authorization
 * - Pack validation (game lookup, pack status check)
 * - Bin creation with pack activation in transaction
 * - Transaction rollback on errors
 * - Audit logging
 *
 * @test-level API
 * @justification Tests API endpoints with authentication, authorization, database operations, and business logic
 * @story 10-5 - Add Bin Functionality
 * @priority P0 (Critical - Security, Data Integrity, Business Logic)
 *
 * RED PHASE: These tests will fail until API endpoints are implemented.
 */

import { test, expect } from "../support/fixtures/rbac.fixture";
import {
  createLotteryGame,
  createLotteryPack,
  createLotteryBin,
} from "../support/factories/lottery.factory";
import { createCompany, createStore, createUser } from "../support/helpers";
import { withBypassClient } from "../support/prisma-bypass";

test.describe("10-5-API: Add Bin Endpoints", () => {
  // ═══════════════════════════════════════════════════════════════════════════
  // GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - AC #3, #4
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-001: [P1] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should validate pack exists and status is RECEIVED (AC #3)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Validating pack for activation
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Validation succeeds
    expect(response.status(), "Expected 200 OK status").toBe(200);
    const body = await response.json();
    expect(body.success, "Response should indicate success").toBe(true);
    expect(body.data.valid, "Pack should be valid").toBe(true);
    expect(body.data.game, "Game info should be present").toBeDefined();
    expect(body.data.game.name, "Game name should match").toBe("$5 Powerball");
    expect(body.data.game.price, "Game price should match").toBe(5.0);
    expect(typeof body.data.game.price, "Game price should be number").toBe("number");
    expect(body.data.pack, "Pack info should be present").toBeDefined();
    expect(body.data.pack.pack_id, "Pack ID should match").toBe(pack.pack_id);
    expect(body.data.pack, "Pack should have serial_start").toHaveProperty("serial_start");
    expect(body.data.pack, "Pack should have serial_end").toHaveProperty("serial_end");
  });

  test("10-5-API-002: [P1] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should reject pack with ACTIVE status (AC #3)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with ACTIVE status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "ACTIVE",
    });

    // WHEN: Validating pack for activation
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Validation fails with appropriate error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body, "Response should have error field").toHaveProperty("error");
    expect(body.error, "Error should be an object").toBeInstanceOf(Object);
    expect(body.error, "Error should have message field").toHaveProperty("message");
    expect(typeof body.error.message, "Error message should be string").toBe("string");
    expect(body.error.message, "Error should mention pack already active").toContain(
      "already active",
    );
  });

  test("10-5-API-003: [P1] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should reject pack with DEPLETED status (AC #3)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with DEPLETED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "DEPLETED",
    });

    // WHEN: Validating pack for activation
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Validation fails with appropriate error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention pack not available").toContain(
      "not available",
    );
  });

  test("10-5-API-004: [P1] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should reject pack not found in inventory (AC #3)", async ({
    storeManagerApiRequest,
    storeManagerUser,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: Pack does not exist in inventory
    const nonExistentPackNumber = "9999999";

    // WHEN: Validating non-existent pack
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${nonExistentPackNumber}`,
    );

    // THEN: Validation fails with pack not found error
    expect(response.status(), "Expected 404 Not Found").toBe(404);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention pack not found").toContain(
      "not found",
    );
  });

  test("10-5-API-005: [P1] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should reject pack with unknown game code (AC #3)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with game code that doesn't match any game
    // Note: This scenario requires pack with invalid game_code or game deleted
    // For this test, we'll create a pack and then delete the game
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "9999", // Unknown game code
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "999912345670123456789012",
      serial_end: "999912345670123456789680",
      status: "RECEIVED",
    });

    // Delete the game to simulate unknown game code scenario
    await prismaClient.lotteryGame.delete({
      where: { game_id: game.game_id },
    });

    // WHEN: Validating pack with unknown game code
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Validation fails with unknown game code error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention unknown game code").toContain(
      "Unknown game code",
    );
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // POST /api/stores/:storeId/lottery/bins/create-with-pack - AC #5
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-006: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should create bin with correct display_order (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    // AND: Existing bins exist (to test auto-assignment of display_order)
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // Create existing bins
    await createLotteryBin(prismaClient, {
      store_id: storeManagerUser.store_id,
      name: "Bin 1",
      display_order: 0,
    });
    await createLotteryBin(prismaClient, {
      store_id: storeManagerUser.store_id,
      name: "Bin 2",
      display_order: 1,
    });

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 3",
        location: "Front Counter",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123", // Mock shift ID
      },
    );

    // THEN: Bin is created with correct display_order (should be 2, next after existing bins)
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const body = await response.json();
    expect(body.success, "Response should indicate success").toBe(true);
    expect(body.data.bin, "Response should contain bin").toBeDefined();
    expect(body.data.bin.display_order, "Display order should be auto-assigned").toBe(2);
    expect(body.data.bin.name, "Bin name should match").toBe("Bin 3");
    expect(body.data.bin.location, "Location should match").toBe("Front Counter");
  });

  test("10-5-API-007: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should update pack status to ACTIVE (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Pack status is updated to ACTIVE
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const body = await response.json();
    expect(body.success, "Response should indicate success").toBe(true);
    const updatedPack = await prismaClient.lotteryPack.findUnique({
      where: { pack_id: pack.pack_id },
    });
    expect(updatedPack?.status, "Pack status should be ACTIVE").toBe("ACTIVE");
    expect(updatedPack?.activated_at, "activated_at should be set").toBeDefined();
    expect(updatedPack?.activated_at, "activated_at should be a Date").toBeInstanceOf(Date);
    expect(updatedPack?.current_bin_id, "current_bin_id should be set").toBeDefined();
    expect(updatedPack?.current_bin_id, "current_bin_id should not be null").not.toBeNull();
  });

  test("10-5-API-008: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should set activated_by and activated_shift_id (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });
    const shiftId = "shift-123";

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: shiftId,
      },
    );

    // THEN: Pack has activated_by and activated_shift_id set
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const updatedPack = await prismaClient.lotteryPack.findUnique({
      where: { pack_id: pack.pack_id },
    });
    expect(updatedPack?.activated_by, "activated_by should be set").toBe(
      storeManagerUser.user_id,
    );
    expect(updatedPack?.activated_shift_id, "activated_shift_id should be set").toBe(
      shiftId,
    );
  });

  test("10-5-API-009: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should create LotteryShiftOpening record (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    // AND: A shift exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // Create a shift for testing
    const shift = await prismaClient.shift.create({
      data: {
        store_id: storeManagerUser.store_id,
        user_id: storeManagerUser.user_id,
        status: "OPEN",
        started_at: new Date(),
      },
    });

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: shift.shift_id,
      },
    );

    // THEN: LotteryShiftOpening record is created
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const shiftOpening = await prismaClient.lotteryShiftOpening.findFirst({
      where: {
        shift_id: shift.shift_id,
        pack_id: pack.pack_id,
      },
    });
    expect(shiftOpening, "LotteryShiftOpening should exist").toBeDefined();
    expect(shiftOpening?.opening_serial, "opening_serial should match").toBe("001");
  });

  test("10-5-API-010: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should create LotteryPackBinHistory record (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: LotteryPackBinHistory record is created
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const body = await response.json();
    const binId = body.data.bin.bin_id;

    const history = await prismaClient.lotteryPackBinHistory.findFirst({
      where: {
        pack_id: pack.pack_id,
        bin_id: binId,
      },
    });
    expect(history, "LotteryPackBinHistory should exist").toBeDefined();
  });

  test("10-5-API-011: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should create AuditLog entry (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with pack activation
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: AuditLog entry is created
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const body = await response.json();
    const binId = body.data.bin.bin_id;

    const auditLog = await prismaClient.auditLog.findFirst({
      where: {
        entity_type: "LOTTERY_BIN",
        entity_id: binId,
        action: "CREATE",
      },
    });
    expect(auditLog, "AuditLog should exist").toBeDefined();
    expect(auditLog?.user_id, "AuditLog user_id should match").toBe(
      storeManagerUser.user_id,
    );
  });

  test("10-5-API-012: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should rollback transaction on error (AC #5)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists but will cause error (e.g., invalid pack status)
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "ACTIVE", // Invalid status - should cause rollback
    });

    // Count existing bins
    const binCountBefore = await prismaClient.lotteryBin.count({
      where: { store_id: storeManagerUser.store_id },
    });

    // WHEN: Attempting to create bin with invalid pack status
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails
    expect(response.status(), "Expected error status").toBeGreaterThanOrEqual(400);

    // AND: No bin is created (transaction rolled back)
    const binCountAfter = await prismaClient.lotteryBin.count({
      where: { store_id: storeManagerUser.store_id },
    });
    expect(binCountAfter, "Bin count should not change").toBe(binCountBefore);

    // AND: Pack status is unchanged
    const unchangedPack = await prismaClient.lotteryPack.findUnique({
      where: { pack_id: pack.pack_id },
    });
    expect(unchangedPack?.status, "Pack status should remain ACTIVE").toBe("ACTIVE");
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // AUTHORIZATION TESTS
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-013: [P0] GET /api/lottery/packs/validate-for-activation/:storeId/:packNumber - should require authentication", async ({
    apiRequest,
    storeManagerUser,
  }) => {
    // GIVEN: I am not authenticated
    // WHEN: Attempting to validate pack
    const response = await apiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/1234567`,
    );

    // THEN: I receive 401 Unauthorized
    expect(response.status(), "Expected 401 Unauthorized").toBe(401);
  });

  test("10-5-API-014: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should require authentication", async ({
    apiRequest,
    storeManagerUser,
  }) => {
    // GIVEN: I am not authenticated
    // WHEN: Attempting to create bin
    const response = await apiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: "1234567",
        serial_start: "001",
        activated_by: "user-123",
        activated_shift_id: "shift-123",
      },
    );

    // THEN: I receive 401 Unauthorized
    expect(response.status(), "Expected 401 Unauthorized").toBe(401);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error, "Error object should be present").toBeDefined();
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // SECURITY TESTS (Mandatory - Applied Automatically)
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-SEC-001: [P0] GET /api/lottery/packs/validate-for-activation - should prevent SQL injection in packNumber parameter", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: Attempting SQL injection in packNumber
    const sqlInjectionAttempts = [
      "1234567' OR '1'='1",
      "1234567'; DROP TABLE lottery_packs;--",
      "1234567' UNION SELECT * FROM users--",
      "'; DELETE FROM lottery_packs WHERE '1'='1",
    ];

    for (const maliciousInput of sqlInjectionAttempts) {
      // WHEN: Attempting SQL injection
      const response = await storeManagerApiRequest.get(
        `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${encodeURIComponent(maliciousInput)}`,
      );

      // THEN: Request should be rejected (not execute SQL)
      // Should return 400 or 404, not 500 (which would indicate SQL execution)
      expect(
        response.status(),
        `SQL injection attempt "${maliciousInput}" should be rejected`,
      ).not.toBe(500);
      expect(
        response.status(),
        `SQL injection attempt "${maliciousInput}" should return error status`,
      ).toBeGreaterThanOrEqual(400);

      const body = await response.json();
      expect(body.success, "Response should indicate failure").toBe(false);
    }
  });

  test("10-5-API-SEC-002: [P0] GET /api/lottery/packs/validate-for-activation - should prevent SQL injection in storeId parameter", async ({
    storeManagerApiRequest,
    storeManagerUser,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: Attempting SQL injection in storeId
    const sqlInjectionAttempts = [
      `${storeManagerUser.store_id}' OR '1'='1`,
      `${storeManagerUser.store_id}'; DROP TABLE stores;--`,
    ];

    for (const maliciousInput of sqlInjectionAttempts) {
      // WHEN: Attempting SQL injection
      const response = await storeManagerApiRequest.get(
        `/api/lottery/packs/validate-for-activation/${encodeURIComponent(maliciousInput)}/1234567`,
      );

      // THEN: Request should be rejected (400 Bad Request - invalid UUID format)
      expect(
        response.status(),
        `SQL injection attempt in storeId should be rejected`,
      ).toBeGreaterThanOrEqual(400);
      expect(response.status(), "Should not be 500 (SQL execution)").not.toBe(500);
    }
  });

  test("10-5-API-SEC-003: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should prevent SQL injection in bin_name", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    const sqlInjectionAttempts = [
      "Bin 1'; DROP TABLE lottery_bins;--",
      "Bin 1' OR '1'='1",
      "'; DELETE FROM lottery_bins WHERE '1'='1",
    ];

    for (const maliciousInput of sqlInjectionAttempts) {
      // WHEN: Attempting SQL injection in bin_name
      const response = await storeManagerApiRequest.post(
        `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
        {
          bin_name: maliciousInput,
          pack_number: pack.pack_number,
          serial_start: "001",
          activated_by: storeManagerUser.user_id,
          activated_shift_id: "shift-123",
        },
      );

      // THEN: Request should be rejected (400 Bad Request - validation error)
      expect(
        response.status(),
        `SQL injection attempt "${maliciousInput}" should be rejected`,
      ).toBeGreaterThanOrEqual(400);
      expect(response.status(), "Should not be 500 (SQL execution)").not.toBe(500);
    }
  });

  test("10-5-API-SEC-004: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should prevent XSS in location field", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    const xssAttempts = [
      "<script>alert('xss')</script>",
      "<img src=x onerror=alert('xss')>",
      "javascript:alert('xss')",
      "<svg onload=alert('xss')>",
    ];

    for (const maliciousInput of xssAttempts) {
      // WHEN: Attempting XSS in location field
      const response = await storeManagerApiRequest.post(
        `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
        {
          bin_name: "Bin 1",
          location: maliciousInput,
          pack_number: pack.pack_number,
          serial_start: "001",
          activated_by: storeManagerUser.user_id,
          activated_shift_id: "shift-123",
        },
      );

      // THEN: Request should succeed (XSS prevention is client-side)
      // BUT: Location should be stored as-is (sanitization happens on display)
      expect(response.status(), "XSS attempt should not break API").toBe(201);
      const body = await response.json();
      expect(body.data.bin.location, "Location should be stored").toBe(maliciousInput);
    }
  });

  test("10-5-API-SEC-005: [P0] GET /api/lottery/packs/validate-for-activation - should enforce authorization (LOTTERY_PACK_READ permission)", async ({
    cashierApiRequest,
    cashierUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Cashier (without LOTTERY_PACK_READ permission)
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: cashierUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Attempting to validate pack without permission
    const response = await cashierApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${cashierUser.store_id}/${pack.pack_number}`,
    );

    // THEN: I receive 403 Forbidden
    expect(response.status(), "Expected 403 Forbidden").toBe(403);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error, "Error object should be present").toBeDefined();
  });

  test("10-5-API-SEC-006: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should enforce authorization (LOTTERY_BIN_MANAGE permission)", async ({
    cashierApiRequest,
    cashierUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Cashier (without LOTTERY_BIN_MANAGE permission)
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: cashierUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Attempting to create bin without permission
    const response = await cashierApiRequest.post(
      `/api/stores/${cashierUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: cashierUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: I receive 403 Forbidden
    expect(response.status(), "Expected 403 Forbidden").toBe(403);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error, "Error object should be present").toBeDefined();
  });

  test("10-5-API-SEC-007: [P0] GET /api/lottery/packs/validate-for-activation - should prevent data leakage (store isolation)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists in a DIFFERENT store
    const otherCompany = await createCompany(prismaClient);
    const otherStore = await createStore(prismaClient, {
      company_id: otherCompany.company_id,
    });
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const otherStorePack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: otherStore.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Attempting to validate pack from different store
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${otherStore.store_id}/${otherStorePack.pack_number}`,
    );

    // THEN: I receive 403 Forbidden (store access denied)
    expect(response.status(), "Expected 403 Forbidden").toBe(403);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention access denied").toContain(
      "Access denied",
    );
  });

  test("10-5-API-SEC-008: [P0] POST /api/stores/:storeId/lottery/bins/create-with-pack - should prevent data leakage (store isolation)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists in a DIFFERENT store
    const otherCompany = await createCompany(prismaClient);
    const otherStore = await createStore(prismaClient, {
      company_id: otherCompany.company_id,
    });
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const otherStorePack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: otherStore.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Attempting to create bin in different store
    const response = await storeManagerApiRequest.post(
      `/api/stores/${otherStore.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: otherStorePack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: I receive 403 Forbidden (store access denied)
    expect(response.status(), "Expected 403 Forbidden").toBe(403);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention access denied").toContain(
      "Access denied",
    );
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // INPUT VALIDATION EDGE CASES (Applied Automatically)
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-EDGE-001: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject empty bin_name", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with empty bin_name
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with validation error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error, "Error object should be present").toBeDefined();
  });

  test("10-5-API-EDGE-002: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject bin_name exceeding max length (255)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with bin_name exceeding 255 characters
    const longBinName = "A".repeat(256);
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: longBinName,
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with validation error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
  });

  test("10-5-API-EDGE-003: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject location exceeding max length (255)", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with location exceeding 255 characters
    const longLocation = "A".repeat(256);
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        location: longLocation,
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with validation error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
  });

  test("10-5-API-EDGE-004: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject negative display_order", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with negative display_order
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        display_order: -1,
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with validation error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
  });

  test("10-5-API-EDGE-005: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject invalid UUID in activated_by", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Creating bin with invalid UUID
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: "not-a-valid-uuid",
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with validation error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
  });

  test("10-5-API-EDGE-006: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should reject pack with RETURNED status", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RETURNED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RETURNED",
    });

    // WHEN: Attempting to create bin with RETURNED pack
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: "shift-123",
      },
    );

    // THEN: Request fails with appropriate error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention pack status").toContain("RECEIVED");
  });

  test("10-5-API-EDGE-007: [P1] GET /api/lottery/packs/validate-for-activation - should reject pack with RETURNED status", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RETURNED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RETURNED",
    });

    // WHEN: Validating RETURNED pack
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Validation fails with appropriate error
    expect(response.status(), "Expected 400 Bad Request").toBe(400);
    const body = await response.json();
    expect(body.success, "Response should indicate failure").toBe(false);
    expect(body.error.message, "Error should mention pack not available").toContain(
      "not available",
    );
  });

  // ═══════════════════════════════════════════════════════════════════════════
  // ENHANCED ASSERTIONS (Applied Automatically)
  // ═══════════════════════════════════════════════════════════════════════════

  test("10-5-API-ENH-001: [P1] GET /api/lottery/packs/validate-for-activation - should return correct response structure", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });

    // WHEN: Validating pack
    const response = await storeManagerApiRequest.get(
      `/api/lottery/packs/validate-for-activation/${storeManagerUser.store_id}/${pack.pack_number}`,
    );

    // THEN: Response has correct structure
    expect(response.status(), "Expected 200 OK status").toBe(200);
    const body = await response.json();
    expect(body, "Response should be an object").toBeInstanceOf(Object);
    expect(body, "Response should have success field").toHaveProperty("success");
    expect(typeof body.success, "Success field should be boolean").toBe("boolean");
    expect(body.success, "Success should be true").toBe(true);
    expect(body, "Response should have data field").toHaveProperty("data");
    expect(body.data, "Data should be an object").toBeInstanceOf(Object);
    expect(body.data, "Data should have valid field").toHaveProperty("valid");
    expect(typeof body.data.valid, "Valid field should be boolean").toBe("boolean");
    expect(body.data.valid, "Valid should be true").toBe(true);
    expect(body.data, "Data should have game field").toHaveProperty("game");
    expect(body.data.game, "Game should be an object").toBeInstanceOf(Object);
    expect(body.data.game, "Game should have name field").toHaveProperty("name");
    expect(typeof body.data.game.name, "Game name should be string").toBe("string");
    expect(body.data.game, "Game should have price field").toHaveProperty("price");
    expect(typeof body.data.game.price, "Game price should be number").toBe("number");
    expect(body.data, "Data should have pack field").toHaveProperty("pack");
    expect(body.data.pack, "Pack should be an object").toBeInstanceOf(Object);
    expect(body.data.pack, "Pack should have pack_id field").toHaveProperty("pack_id");
    expect(typeof body.data.pack.pack_id, "Pack ID should be string").toBe("string");
  });

  test("10-5-API-ENH-002: [P1] POST /api/stores/:storeId/lottery/bins/create-with-pack - should return correct response structure", async ({
    storeManagerApiRequest,
    storeManagerUser,
    prismaClient,
  }) => {
    // GIVEN: I am authenticated as a Store Manager
    // AND: A pack exists with RECEIVED status
    // AND: A shift exists
    const game = await createLotteryGame(prismaClient, {
      name: "$5 Powerball",
      price: 5.0,
      game_code: "0001",
    });
    const pack = await createLotteryPack(prismaClient, {
      game_id: game.game_id,
      store_id: storeManagerUser.store_id,
      pack_number: "1234567",
      serial_start: "000112345670123456789012",
      serial_end: "000112345670123456789680",
      status: "RECEIVED",
    });
    const shift = await prismaClient.shift.create({
      data: {
        store_id: storeManagerUser.store_id,
        user_id: storeManagerUser.user_id,
        status: "OPEN",
        started_at: new Date(),
      },
    });

    // WHEN: Creating bin
    const response = await storeManagerApiRequest.post(
      `/api/stores/${storeManagerUser.store_id}/lottery/bins/create-with-pack`,
      {
        bin_name: "Bin 1",
        pack_number: pack.pack_number,
        serial_start: "001",
        activated_by: storeManagerUser.user_id,
        activated_shift_id: shift.shift_id,
      },
    );

    // THEN: Response has correct structure
    expect(response.status(), "Expected 201 Created status").toBe(201);
    const body = await response.json();
    expect(body, "Response should be an object").toBeInstanceOf(Object);
    expect(body, "Response should have success field").toHaveProperty("success");
    expect(typeof body.success, "Success field should be boolean").toBe("boolean");
    expect(body.success, "Success should be true").toBe(true);
    expect(body, "Response should have data field").toHaveProperty("data");
    expect(body.data, "Data should be an object").toBeInstanceOf(Object);
    expect(body.data, "Data should have bin field").toHaveProperty("bin");
    expect(body.data.bin, "Bin should be an object").toBeInstanceOf(Object);
    expect(body.data.bin, "Bin should have bin_id field").toHaveProperty("bin_id");
    expect(typeof body.data.bin.bin_id, "Bin ID should be string").toBe("string");
    expect(body.data.bin.bin_id.length, "Bin ID should be valid UUID length").toBeGreaterThan(
      0,
    );
    expect(body.data.bin, "Bin should have name field").toHaveProperty("name");
    expect(typeof body.data.bin.name, "Bin name should be string").toBe("string");
    expect(body.data.bin.name.length, "Bin name should not be empty").toBeGreaterThan(0);
    expect(body.data.bin.name.length, "Bin name should not exceed 255 chars").toBeLessThanOrEqual(
      255,
    );
    expect(body.data.bin, "Bin should have display_order field").toHaveProperty("display_order");
    expect(typeof body.data.bin.display_order, "Display order should be number").toBe("number");
    expect(
      body.data.bin.display_order,
      "Display order should be non-negative",
    ).toBeGreaterThanOrEqual(0);
    expect(body.data.bin, "Bin should have is_active field").toHaveProperty("is_active");
    expect(typeof body.data.bin.is_active, "Is active should be boolean").toBe("boolean");
  });
});
