// tests/api/store-settings.api.spec.ts
import { test, expect } from "../support/fixtures/rbac.fixture";
import { createCompany, createUser, createStore } from "../support/helpers";

/**
 * Store Settings API Tests
 * 
 * Tests the store settings API endpoints for viewing and updating store configuration.
 * 
 * API tests are THIRD in pyramid order (15-25% of tests)
 * 
 * ENDPOINTS TESTED:
 * - GET /api/client/stores/:storeId/settings
 * - PUT /api/client/stores/:storeId/settings
 * 
 * PRIORITY: P1 (High) - Store configuration management
 */

test.describe("Store Settings API", () => {
  test("[P1-AC-3] GET /api/client/stores/:storeId/settings returns store configuration", async ({
    clientUserApiRequest,
    clientUser,
    prismaClient,
  }) => {
    // GIVEN: A client owner with a store (using store from clientUser fixture)
    // Update the existing store with test configuration
    await prismaClient.store.update({
      where: { store_id: clientUser.store_id },
      data: {
        configuration: {
          contact_email: "store@example.com",
          timezone: "America/New_York",
          operating_hours: {
            monday: { open: "09:00", close: "17:00" },
          },
        },
      },
    });

    const store = await prismaClient.store.findUnique({
      where: { store_id: clientUser.store_id },
    });

    // WHEN: Fetching store settings
    const response = await clientUserApiRequest.get(
      `/api/client/stores/${clientUser.store_id}/settings`,
    );

    // THEN: Returns store configuration
    expect(response.status()).toBe(200);
    const body = await response.json();
    expect(body.success).toBe(true);
    expect(body.data).toMatchObject({
      name: store!.name,
      contact_email: "store@example.com",
      timezone: "America/New_York",
    });
  });

  test("[P1-AC-3] PUT /api/client/stores/:storeId/settings updates store configuration", async ({
    clientUserApiRequest,
    clientUser,
    prismaClient,
  }) => {
    // GIVEN: A client owner with a store (using store from clientUser fixture)
    const updatedConfig = {
      contact_email: "newemail@example.com",
      timezone: "America/Los_Angeles",
      operating_hours: {
        monday: { open: "10:00", close: "18:00" },
      },
    };

    // WHEN: Updating store settings
    const response = await clientUserApiRequest.put(
      `/api/client/stores/${clientUser.store_id}/settings`,
      updatedConfig,
    );

    // THEN: Returns success and configuration is updated
    expect(response.status()).toBe(200);
    const body = await response.json();
    expect(body.success).toBe(true);
    expect(body.data).toBeDefined();
    
    // Verify configuration was updated in database
    const updatedStore = await prismaClient.store.findUnique({
      where: { store_id: clientUser.store_id },
      select: { configuration: true },
    });
    expect(updatedStore).toBeDefined();
    const config = updatedStore?.configuration as any;
    expect(config?.contact_email).toBe("newemail@example.com");
    expect(config?.timezone).toBe("America/Los_Angeles");
    expect(config?.operating_hours?.monday?.open).toBe("10:00");
    expect(config?.operating_hours?.monday?.close).toBe("18:00");
  });

  test("[P1-AC-3] PUT /api/client/stores/:storeId/settings validates timezone format", async ({
    clientUserApiRequest,
    clientUser,
    prismaClient,
  }) => {
    // GIVEN: A client owner with a store (using store from clientUser fixture)

    // WHEN: Updating with invalid timezone
    const response = await clientUserApiRequest.put(
      `/api/client/stores/${clientUser.store_id}/settings`,
      { timezone: "invalid-timezone" },
    );

    // THEN: Returns validation error
    expect(response.status()).toBe(400);
    const body = await response.json();
    expect(body.success).toBe(false);
    const errorMessage = typeof body.error === "object" ? body.error.message || body.error.code : body.error || "";
    expect(errorMessage.toLowerCase()).toMatch(/timezone|invalid|format/i);
  });

  test("[P1-AC-3] PUT /api/client/stores/:storeId/settings enforces RLS - user can only update own stores", async ({
    clientUserApiRequest,
    clientUser,
    prismaClient,
  }) => {
    // GIVEN: Another client owner with their own store
    const owner2 = await createUser(prismaClient);
    const company2 = await createCompany(prismaClient, {
      owner_user_id: owner2.user_id,
    });
    const store2 = await createStore(prismaClient, {
      company_id: company2.company_id,
    });

    // WHEN: clientUser (owner1) tries to update Owner2's store
    const response = await clientUserApiRequest.put(
      `/api/client/stores/${store2.store_id}/settings`,
      { contact_email: "hacked@example.com" },
    );

    // THEN: Returns 403 Forbidden or 404 Not Found
    expect([403, 404]).toContain(response.status());
  });
});
