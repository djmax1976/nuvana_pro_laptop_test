// tests/unit/settings/store-settings-validation.test.ts
import { describe, it, expect } from "vitest";
import { z } from "zod";

/**
 * Unit tests for store settings validation logic
 * 
 * These tests validate pure business logic for:
 * - Store configuration validation (timezone, operating hours)
 * - Email validation
 * - Password strength validation
 * - PIN validation
 * 
 * FOUNDATION: Unit tests are the base of the test pyramid (40-60% of tests)
 */

// Store configuration validation schema
const storeConfigurationSchema = z.object({
  contact_email: z.string().email("Invalid email format"),
  timezone: z
    .string()
    .min(1, "Timezone is required")
    .refine(
      (val) => {
        // Basic IANA timezone format validation
        return /^[A-Z][a-z]+\/[A-Z][a-z_]+$/.test(val);
      },
      "Timezone must be in IANA format (e.g., America/New_York)",
    ),
  operating_hours: z.object({
    monday: z.object({
      open: z.string().regex(/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/),
      close: z.string().regex(/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/),
    }).optional(),
    tuesday: z.object({
      open: z.string().regex(/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/),
      close: z.string().regex(/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/),
    }).optional(),
    // ... other days
  }),
  address: z.object({
    street: z.string().optional(),
    city: z.string().optional(),
    state: z.string().optional(),
    zip: z.string().optional(),
  }).optional(),
});

// Password validation function (matches backend requirements)
function validatePasswordStrength(password: string): {
  valid: boolean;
  error?: string;
} {
  if (password.length < 8) {
    return { valid: false, error: "Password must be at least 8 characters" };
  }
  if (!/[A-Z]/.test(password)) {
    return { valid: false, error: "Password must contain at least one uppercase letter" };
  }
  if (!/[a-z]/.test(password)) {
    return { valid: false, error: "Password must contain at least one lowercase letter" };
  }
  if (!/[0-9]/.test(password)) {
    return { valid: false, error: "Password must contain at least one number" };
  }
  if (!/[^A-Za-z0-9]/.test(password)) {
    return { valid: false, error: "Password must contain at least one special character" };
  }
  if (/\s/.test(password)) {
    return { valid: false, error: "Password cannot contain whitespace" };
  }
  return { valid: true };
}

// PIN validation function (4 digits, numeric only)
function validatePIN(pin: string): { valid: boolean; error?: string } {
  if (pin.length !== 4) {
    return { valid: false, error: "PIN must be exactly 4 digits" };
  }
  if (!/^\d{4}$/.test(pin)) {
    return { valid: false, error: "PIN must contain only numeric digits (0-9)" };
  }
  return { valid: true };
}

// Email validation function
function validateEmail(email: string): { valid: boolean; error?: string } {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return { valid: false, error: "Invalid email format" };
  }
  return { valid: true };
}

describe("Store Settings Validation", () => {
  describe("validateEmail", () => {
    it("should accept valid email addresses", () => {
      // GIVEN: A valid email address
      const email = "user@example.com";

      // WHEN: Validating the email
      const result = validateEmail(email);

      // THEN: Validation passes
      expect(result.valid).toBe(true);
      expect(result.error).toBeUndefined();
    });

    it("should reject invalid email format", () => {
      // GIVEN: An invalid email address
      const email = "invalid-email";

      // WHEN: Validating the email
      const result = validateEmail(email);

      // THEN: Validation fails with error message
      expect(result.valid).toBe(false);
      expect(result.error).toContain("Invalid email format");
    });

    it("should reject email without domain", () => {
      // GIVEN: An email without domain
      const email = "user@";

      // WHEN: Validating the email
      const result = validateEmail(email);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
    });
  });

  describe("validatePasswordStrength", () => {
    it("should accept valid passwords meeting all requirements", () => {
      // GIVEN: A password meeting all requirements
      const password = "ValidPass123!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation passes
      expect(result.valid).toBe(true);
    });

    it("should reject passwords shorter than 8 characters", () => {
      // GIVEN: A password shorter than 8 characters
      const password = "Short1!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("at least 8 characters");
    });

    it("should reject passwords without uppercase letter", () => {
      // GIVEN: A password without uppercase letter
      const password = "lowercase123!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("uppercase");
    });

    it("should reject passwords without lowercase letter", () => {
      // GIVEN: A password without lowercase letter
      const password = "UPPERCASE123!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("lowercase");
    });

    it("should reject passwords without number", () => {
      // GIVEN: A password without number
      const password = "NoNumber!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("number");
    });

    it("should reject passwords without special character", () => {
      // GIVEN: A password without special character
      const password = "NoSpecial123";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("special character");
    });

    it("should reject passwords with whitespace", () => {
      // GIVEN: A password with whitespace
      const password = "Valid Pass123!";

      // WHEN: Validating password strength
      const result = validatePasswordStrength(password);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("whitespace");
    });
  });

  describe("validatePIN", () => {
    it("should accept valid 4-digit PINs", () => {
      // GIVEN: A valid 4-digit PIN
      const pin = "1234";

      // WHEN: Validating the PIN
      const result = validatePIN(pin);

      // THEN: Validation passes
      expect(result.valid).toBe(true);
    });

    it("should reject PINs shorter than 4 digits", () => {
      // GIVEN: A PIN shorter than 4 digits
      const pin = "123";

      // WHEN: Validating the PIN
      const result = validatePIN(pin);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("exactly 4 digits");
    });

    it("should reject PINs longer than 4 digits", () => {
      // GIVEN: A PIN longer than 4 digits
      const pin = "12345";

      // WHEN: Validating the PIN
      const result = validatePIN(pin);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("exactly 4 digits");
    });

    it("should reject PINs with non-numeric characters", () => {
      // GIVEN: A PIN with non-numeric characters
      const pin = "12ab";

      // WHEN: Validating the PIN
      const result = validatePIN(pin);

      // THEN: Validation fails
      expect(result.valid).toBe(false);
      expect(result.error).toContain("numeric digits");
    });
  });

  describe("storeConfigurationSchema", () => {
    it("should accept valid store configuration", () => {
      // GIVEN: Valid store configuration
      const config = {
        contact_email: "store@example.com",
        timezone: "America/New_York",
        operating_hours: {
          monday: { open: "09:00", close: "17:00" },
        },
      };

      // WHEN: Validating configuration
      const result = storeConfigurationSchema.safeParse(config);

      // THEN: Validation passes
      expect(result.success).toBe(true);
    });

    it("should reject invalid timezone format", () => {
      // GIVEN: Invalid timezone format
      const config = {
        contact_email: "store@example.com",
        timezone: "invalid-timezone",
        operating_hours: {},
      };

      // WHEN: Validating configuration
      const result = storeConfigurationSchema.safeParse(config);

      // THEN: Validation fails
      expect(result.success).toBe(false);
    });

    it("should reject invalid email format", () => {
      // GIVEN: Invalid email format
      const config = {
        contact_email: "invalid-email",
        timezone: "America/New_York",
        operating_hours: {},
      };

      // WHEN: Validating configuration
      const result = storeConfigurationSchema.safeParse(config);

      // THEN: Validation fails
      expect(result.success).toBe(false);
    });
  });
});
